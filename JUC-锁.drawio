<mxfile host="app.diagrams.net" modified="2021-07-05T05:52:42.475Z" agent="5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.114 Safari/537.36" etag="jF6ERECNZMvQ12rmU7G-" version="14.8.3" type="github" pages="7">
  <diagram name="(互斥锁)加锁" id="5d7acffa-a066-3a61-03fe-96351882024d">
    <mxGraphModel dx="514" dy="1325" grid="0" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1000" pageHeight="2000" background="#ffffff" math="0" shadow="1">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="CqtvCm25UIUQusRmt474-23" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontColor=#000000;" parent="1" source="CqtvCm25UIUQusRmt474-13" target="CqtvCm25UIUQusRmt474-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-6" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryAcquire()&lt;/span&gt;&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=30;fontColor=#000000;" parent="CqtvCm25UIUQusRmt474-23" vertex="1" connectable="0">
          <mxGeometry x="0.5831" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="MHK901CGgSBkAFWm6LKR-1" value="公平锁" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#000000;" vertex="1" connectable="0" parent="CqtvCm25UIUQusRmt474-23">
          <mxGeometry x="0.2623" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-27" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryAcquire()&lt;/span&gt;&lt;/pre&gt;" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontColor=#000000;" parent="1" source="CqtvCm25UIUQusRmt474-13" target="CqtvCm25UIUQusRmt474-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="MHK901CGgSBkAFWm6LKR-2" value="非公平锁" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#000000;" vertex="1" connectable="0" parent="CqtvCm25UIUQusRmt474-27">
          <mxGeometry x="0.3266" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.446;entryY=0.002;entryDx=0;entryDy=0;entryPerimeter=0;fontSize=30;fontColor=#000000;" parent="1" source="CqtvCm25UIUQusRmt474-13" target="CqtvCm25UIUQusRmt474-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-8" value="&lt;pre style=&quot;text-align: left ; background-color: rgb(248 , 249 , 250) ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;b&gt;acquireQueued()&lt;/b&gt;&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=30;fontColor=#000000;" parent="krwOEIBx-vB3lfnVqGeh-7" vertex="1" connectable="0">
          <mxGeometry x="0.177" y="1" relative="1" as="geometry">
            <mxPoint y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-13" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public final void &lt;/span&gt;acquire(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;arg) {//模板方法，tryAcquire()由子类负责实现&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(!tryAcquire(arg) &amp;amp;&amp;amp;&lt;br&gt;        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))&lt;br&gt;        selfInterrupt();&lt;br&gt;}&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fontColor=#000000;align=left;" parent="1" vertex="1">
          <mxGeometry x="3070" y="740" width="778" height="133" as="geometry" />
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontColor=#000000;" parent="1" source="CqtvCm25UIUQusRmt474-14" target="CqtvCm25UIUQusRmt474-13" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3036" y="631" />
              <mxPoint x="3410" y="631" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-14" value="&lt;span style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt; font-weight: bold;&quot;&gt;final void &lt;/span&gt;&lt;span style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt; font-weight: bold; font-style: italic;&quot;&gt;lock&lt;/span&gt;&lt;span style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;() {&lt;/span&gt;&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;acquire&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;align=left;arcSize=9;labelBorderColor=none;" parent="1" vertex="1">
          <mxGeometry x="2930" y="400" width="232" height="107" as="geometry" />
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-21" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontColor=#000000;" parent="1" source="CqtvCm25UIUQusRmt474-19" target="CqtvCm25UIUQusRmt474-13" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3707" y="633" />
              <mxPoint x="3410" y="633" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-19" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;lock&lt;/span&gt;&lt;span&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;compareAndSetState&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;))//立即抢锁&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;currentThread&lt;/span&gt;&lt;span&gt;())&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;else&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;        &lt;/span&gt;&lt;span&gt;acquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;//抢锁失败，&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;align=left;arcSize=8;" parent="1" vertex="1">
          <mxGeometry x="3470" y="400" width="580" height="180" as="geometry" />
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-22" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;currentThread&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span&gt;getState&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;!&lt;/span&gt;&lt;span&gt;hasQueuedPredecessors&lt;/span&gt;&lt;span&gt;() &lt;/span&gt;&lt;span&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span&gt;compareAndSetState&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    }&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;else if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;&lt;span&gt;getExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;()) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;+ &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span&gt;&amp;lt; &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;)&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;&lt;span&gt;Error&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;&quot;Maximum lock count exceeded&quot;&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;setState&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return false&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;align=left;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="2443" y="1025" width="777" height="425" as="geometry" />
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=30;fontColor=#000000;" parent="1" source="CqtvCm25UIUQusRmt474-26" target="krwOEIBx-vB3lfnVqGeh-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-26" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span&gt;nonfairTryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;br&gt;&lt;/pre&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;strokeColor=#000000;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="3744" y="1023" width="523" height="138" as="geometry" />
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-29" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;公平锁与非公平锁tryAcquire()的&lt;/span&gt;实现唯一的区别是，公平锁多了了一个!hasQueuedPredecessors()判断,&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;hasQueuedPredecessors()&lt;/span&gt;表示排队队列不为空，并且排在队头的节点不是当前线程&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;!hasQueuedPredecessors()表示排队队列为空，或者排在队头的节点是当前线程&lt;/pre&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;glass=0;labelBackgroundColor=#ffffff;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="2433" y="1466" width="946" height="113" as="geometry" />
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-30" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;b&gt;这个方法只有抢到锁之后才会返回,&lt;/b&gt;&lt;/pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;&lt;b&gt;该函数不会中断响应，但它会记录被阻塞期间有没有其他线程向它发送过中断信号。如果有，则该函数会返回true；否则，返回false。&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquireQueued&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;try &lt;/span&gt;&lt;span&gt;{&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interrupted &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;false&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;for &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;;;&lt;/span&gt;&lt;span&gt;) {//在没有阻塞的情况下，不断取获取锁&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;predecessor&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;head &lt;span&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span&gt;tryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span&gt;setHead&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;next &lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;null&lt;/span&gt;&lt;span&gt;; &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;// help GC&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;false&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interrupted&lt;/span&gt;&lt;span&gt;;//获取锁之后，返回&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;shouldParkAfterFailedAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;&lt;span&gt;) &lt;/span&gt;&lt;span&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span&gt;parkAndCheckInterrupt&lt;/span&gt;&lt;span&gt;()){&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt; &lt;/span&gt;//&lt;/span&gt;shouldParkAfterFailedAcquire&lt;span style=&quot;font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;)判断是否需要阻塞&lt;/span&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interrupted &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;true&lt;/span&gt;&lt;span&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;&lt;span&gt; &lt;/span&gt;    }&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    } &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;finally &lt;/span&gt;&lt;span&gt;{&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed&lt;/span&gt;&lt;span&gt;)&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;cancelAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-size: 12px&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;阻塞当前线程,直到被其他线程唤醒或者被中断，该函数才返回；park（）函数返回有两种情况。&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;情况1：其他线程调用了unpark（Thread t）。&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;情况2：其他线程调用了t.interrupt（）。这里要注意的是，lock（）不能响应中断，但LockSupport.park（）会响应中断。&lt;/pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;也正因为LockSupport.park（）可能被中断唤醒，acquireQueued（..）函数才写了一个for死循环；&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;唤醒之后，如果发现自己排在队列头部，就去拿锁；如果拿不到锁，则再次自己阻塞自己；&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;不断重复此过程，直到拿到锁。被唤醒之后，通过Thread.interrupted（）来判断是否被中断唤醒；&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;如果是情况1，会返回false；&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;如果是情况2，则返回true；&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;private final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;parkAndCheckInterrupt&lt;/span&gt;&lt;span&gt;() {&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-size: 12px&quot;&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;LockSupport&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;park&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;Thread&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;interrupted&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;pre&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=none;strokeColor=#000000;fillColor=#ffffff;align=left;arcSize=8;" parent="1" vertex="1">
          <mxGeometry x="2967" y="1821" width="1104" height="1043" as="geometry" />
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=30;fontColor=#000000;" parent="1" source="_KA6L-gr-Qn6RJLEGgCv-1" target="CqtvCm25UIUQusRmt474-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_KA6L-gr-Qn6RJLEGgCv-1" value="公平锁" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;glass=0;labelBackgroundColor=none;fontColor=#000000;fontSize=30;" parent="1" vertex="1">
          <mxGeometry x="2971" y="314" width="150" height="20" as="geometry" />
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=30;fontColor=#000000;" parent="1" source="_KA6L-gr-Qn6RJLEGgCv-2" target="CqtvCm25UIUQusRmt474-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_KA6L-gr-Qn6RJLEGgCv-2" value="&lt;span style=&quot;text-align: left; font-size: 30px;&quot;&gt;非公平锁&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;glass=0;labelBackgroundColor=none;fontColor=#000000;fontSize=30;" parent="1" vertex="1">
          <mxGeometry x="3685" y="317" width="150" height="17" as="geometry" />
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-1" value="tryLock（）实现分析" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;glass=0;labelBackgroundColor=none;fontSize=30;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="4045" y="1185" width="350" height="50" as="geometry" />
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-4" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-size: 12.8pt ; white-space: normal ; font-weight: bold&quot;&gt;final boolean &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; white-space: normal ; font-weight: bold ; font-style: italic&quot;&gt;nonfairTryAcquire&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; white-space: normal&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; white-space: normal ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; white-space: normal ; font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; white-space: normal&quot;&gt;) {&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;currentThread&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span&gt;getState&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;compareAndSetState&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    }&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;else if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;&lt;span&gt;getExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;()) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;+ &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span&gt;&amp;lt; &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;) &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;// overflow&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;&lt;span&gt;Error&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;&quot;Maximum lock count exceeded&quot;&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;setState&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return false&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;strokeColor=#000000;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="3688" y="1251" width="635" height="453" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="szI1ShmyNPP52Lu-LX1a" name="(互斥锁)释放锁">
    <mxGraphModel dx="2514" dy="1325" grid="0" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="2000" pageHeight="2000" math="0" shadow="0">
      <root>
        <mxCell id="kUkIeRc0tFKLB3FnhXx1-0" />
        <mxCell id="kUkIeRc0tFKLB3FnhXx1-1" parent="kUkIeRc0tFKLB3FnhXx1-0" />
        <mxCell id="gaisI5OQv5GdU1nkk_C--0" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.513;entryY=-0.003;entryDx=0;entryDy=0;entryPerimeter=0;fontColor=#000000;" edge="1" parent="kUkIeRc0tFKLB3FnhXx1-1" source="hQ5Be9MLbmskBuh1OfqU-1" target="hQ5Be9MLbmskBuh1OfqU-10">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="gaisI5OQv5GdU1nkk_C--4" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;unparkSuccessor()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#000000;fontSize=14;" vertex="1" connectable="0" parent="gaisI5OQv5GdU1nkk_C--0">
          <mxGeometry x="-0.311" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gaisI5OQv5GdU1nkk_C--1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="kUkIeRc0tFKLB3FnhXx1-1" source="hQ5Be9MLbmskBuh1OfqU-1" target="hQ5Be9MLbmskBuh1OfqU-2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="gaisI5OQv5GdU1nkk_C--3" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;tryRelease()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#000000;fontSize=14;" vertex="1" connectable="0" parent="gaisI5OQv5GdU1nkk_C--1">
          <mxGeometry x="0.1688" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="hQ5Be9MLbmskBuh1OfqU-1" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;release&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;) {//模板方法&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(tryRelease(&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;)) {释放锁；&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;= head;&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;!= &lt;span style=&quot;font-weight: bold&quot;&gt;null &lt;/span&gt;&amp;amp;&amp;amp; &lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;.waitStatus != 0)&lt;br&gt;            unparkSuccessor(&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;);//唤醒队列中的其他线程;&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;return true&lt;/span&gt;;&lt;br&gt;    }&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;return false&lt;/span&gt;;&lt;br&gt;}&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=30;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;align=left;" parent="kUkIeRc0tFKLB3FnhXx1-1" vertex="1">
          <mxGeometry x="690" y="260" width="540" height="240" as="geometry" />
        </mxCell>
        <mxCell id="hQ5Be9MLbmskBuh1OfqU-2" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryRelease&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;releases&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span&gt;getState&lt;/span&gt;&lt;span&gt;() &lt;/span&gt;&lt;span&gt;- &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;releases&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;currentThread&lt;/span&gt;&lt;span&gt;() &lt;/span&gt;&lt;span&gt;!= &lt;/span&gt;&lt;span&gt;getExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;())&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;&lt;span&gt;IllegalMonitorStateException&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;//不是持有锁的线程释放&lt;/span&gt;直接报错&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;free &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;false&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;) {//每调用一次，state减1，直到为0，才表示锁释放成功&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;free &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;null&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-size: 16px&quot;&gt;&lt;font face=&quot;pt mono&quot; style=&quot;font-size: 16px&quot;&gt;因为是排他锁，只有已经持有锁的线程才有资格调用release（..），这意味着没有其他线程与它争抢。&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;font-size: 16px&quot;&gt;&lt;font style=&quot;font-size: 16px&quot;&gt;所以，在上面的tryRelease（..）函数中，对state值的修改，不需要CAS操作，直接减1即可；&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;font-size: 16px&quot;&gt;&lt;font style=&quot;font-size: 16px&quot; color=&quot;#4c0099&quot;&gt;注意，加锁和解锁必须成对出现&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;font-size: 16px&quot;&gt;&lt;font style=&quot;font-size: 16px&quot;&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;    &lt;/span&gt;&lt;b&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;setState&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;)&lt;/span&gt;&lt;/b&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;&lt;b&gt;;&lt;/b&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-weight: bold&quot;&gt;free&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;}&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=30;strokeColor=#000000;fillColor=#ffffff;align=left;labelBorderColor=none;arcSize=9;" parent="kUkIeRc0tFKLB3FnhXx1-1" vertex="1">
          <mxGeometry x="200" y="685" width="800" height="490" as="geometry" />
        </mxCell>
        <mxCell id="hQ5Be9MLbmskBuh1OfqU-10" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;唤醒队列中的其他线程&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;private void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;unparkSuccessor&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;) {&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * If status is negative (i.e., possibly needing signal) try&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * to clear in anticipation of signalling.  It is OK if this&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * fails or if status is changed by waiting thread.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;= &lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;.waitStatus;&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&amp;lt; 0)&lt;br&gt;        compareAndSetWaitStatus(&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;, &lt;span style=&quot;font-weight: bold&quot;&gt;ws&lt;/span&gt;, 0);&lt;br&gt;&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * Thread to unpark is held in successor, which is normally&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * just the next node.  But if cancelled or apparently null,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * traverse backwards from tail to find the actual&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * non-cancelled successor.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;= &lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;.next;&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;== &lt;span style=&quot;font-weight: bold&quot;&gt;null &lt;/span&gt;|| &lt;span style=&quot;font-weight: bold&quot;&gt;s&lt;/span&gt;.waitStatus &amp;gt; 0) {&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;= &lt;span style=&quot;font-weight: bold&quot;&gt;null&lt;/span&gt;;&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;for &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;= tail; &lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;!= &lt;span style=&quot;font-weight: bold&quot;&gt;null &lt;/span&gt;&amp;amp;&amp;amp; &lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;!= &lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;; &lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;= &lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;.prev)&lt;br&gt;            &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;.waitStatus &amp;lt;= 0)&lt;br&gt;                &lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;= &lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;;&lt;br&gt;    }&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;!= &lt;span style=&quot;font-weight: bold&quot;&gt;null&lt;/span&gt;)&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;LockSupport&lt;/span&gt;.unpark(&lt;span style=&quot;font-weight: bold&quot;&gt;s&lt;/span&gt;.thread);&lt;font color=&quot;#ff0080&quot;&gt;//唤醒下一个在等待队列里阻塞的线程&lt;br&gt;}&lt;/font&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=22;strokeColor=#000000;fillColor=#ffffff;align=left;arcSize=9;" parent="kUkIeRc0tFKLB3FnhXx1-1" vertex="1">
          <mxGeometry x="1080" y="685" width="720" height="680" as="geometry" />
        </mxCell>
        <mxCell id="SMU3NQiLPeNhD6TF8_aj-0" value="&lt;span style=&quot;text-align: center ; background-color: rgb(248 , 249 , 250)&quot;&gt;&lt;font style=&quot;font-size: 16px&quot;&gt;解锁不区分公平与非公平&lt;/font&gt;&lt;/span&gt;" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.cloud_callout;labelBackgroundColor=#ffffff;fontSize=18;fontColor=#000000;align=left;" vertex="1" parent="kUkIeRc0tFKLB3FnhXx1-1">
          <mxGeometry x="1230" y="190" width="220" height="90" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="JNv3_J8_Sh6OVfC3o5AA" name="(互斥锁)中断锁">
    <mxGraphModel dx="2514" dy="1325" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="2000" pageHeight="2000" math="0" shadow="0">
      <root>
        <mxCell id="GkP1prsd0XOYrcYADEeq-0" />
        <mxCell id="GkP1prsd0XOYrcYADEeq-1" parent="GkP1prsd0XOYrcYADEeq-0" />
        <mxCell id="SpEC_mB6sUZVsmlTsD8X-0" value="lockInterruptibly（）实现分析" style="text;whiteSpace=wrap;html=1;fontSize=22;fontColor=#000000;" parent="GkP1prsd0XOYrcYADEeq-1" vertex="1">
          <mxGeometry x="1180" y="60" width="310" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SpEC_mB6sUZVsmlTsD8X-2" value="&lt;font style=&quot;font-size: 16px&quot;&gt;lock（）不能被中断，lockInterruptibly（）可以被中断；lock（）必须等被中断的线程获取锁之后才能响应中断&lt;br&gt;&lt;/font&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;lockInterruptibly&lt;/span&gt;&lt;span&gt;() &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;throws &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;InterruptedException &lt;/span&gt;&lt;span&gt;{&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;sync&lt;span&gt;.&lt;/span&gt;&lt;span&gt;acquireInterruptibly&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;br&gt;&lt;/pre&gt;&lt;br&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=22;strokeColor=#000000;fillColor=#ffffff;align=left;" parent="GkP1prsd0XOYrcYADEeq-1" vertex="1">
          <mxGeometry x="990" y="110" width="730" height="240" as="geometry" />
        </mxCell>
        <mxCell id="5fQTfYabW9B-tewhtZIN-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#000000;exitX=0;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="GkP1prsd0XOYrcYADEeq-1" source="B13aK4WdRRfeDaFlvRMU-0" target="5fQTfYabW9B-tewhtZIN-0">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="5fQTfYabW9B-tewhtZIN-4" value="公平" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=14;fontColor=#000000;" vertex="1" connectable="0" parent="5fQTfYabW9B-tewhtZIN-2">
          <mxGeometry x="0.3526" y="2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="5fQTfYabW9B-tewhtZIN-7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#000000;" edge="1" parent="GkP1prsd0XOYrcYADEeq-1" source="B13aK4WdRRfeDaFlvRMU-0" target="5fQTfYabW9B-tewhtZIN-5">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="800" y="530" />
              <mxPoint x="800" y="1120" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="5fQTfYabW9B-tewhtZIN-8" value="非公平" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=14;fontColor=#000000;" vertex="1" connectable="0" parent="5fQTfYabW9B-tewhtZIN-7">
          <mxGeometry x="-0.0879" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="5fQTfYabW9B-tewhtZIN-9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.488;entryY=-0.004;entryDx=0;entryDy=0;entryPerimeter=0;fontSize=14;fontColor=#000000;" edge="1" parent="GkP1prsd0XOYrcYADEeq-1" source="B13aK4WdRRfeDaFlvRMU-0" target="B13aK4WdRRfeDaFlvRMU-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="B13aK4WdRRfeDaFlvRMU-0" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public final void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquireInterruptibly&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;) &lt;span style=&quot;font-weight: bold&quot;&gt;throws &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;InterruptedException &lt;/span&gt;{&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;.interrupted())&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;InterruptedException();//如果当前线程被中断了，直接抛中断异常&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(!tryAcquire(&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;))//这里的tryAcquire()和lock()里的实现一样，分为公平实现和非公平实现&lt;br&gt;        doAcquireInterruptibly(&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;);&lt;br&gt;}&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=22;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;align=left;" parent="GkP1prsd0XOYrcYADEeq-1" vertex="1">
          <mxGeometry x="960" y="430" width="860" height="200" as="geometry" />
        </mxCell>
        <mxCell id="B13aK4WdRRfeDaFlvRMU-1" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold&quot;&gt;private void &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold ; font-style: italic&quot;&gt;doAcquireInterruptibly&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold&quot;&gt;throws &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold&quot;&gt;InterruptedException &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;{&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span&gt;addWaiter&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;EXCLUSIVE)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;try &lt;/span&gt;&lt;span&gt;{&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;for &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;;;&lt;/span&gt;&lt;span&gt;) {//&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;predecessor&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;head &lt;span&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span&gt;tryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span&gt;setHead&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;next &lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;null&lt;/span&gt;&lt;span&gt;; &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;// help GC&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;false&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;shouldParkAfterFailedAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;) &lt;/span&gt;&lt;span&gt;&amp;amp;&amp;amp;&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span&gt;parkAndCheckInterrupt&lt;/span&gt;&lt;span&gt;())&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;b&gt;               &lt;font color=&quot;#ea6b66&quot;&gt; //和acquireQueued()实现一样，唯一的区别是返回布尔值还是抛异常&lt;/font&gt;&lt;/b&gt;&lt;/pre&gt;&lt;span&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;&lt;span&gt;InterruptedException&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    } &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;finally &lt;/span&gt;&lt;span&gt;{&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed&lt;/span&gt;&lt;span&gt;)&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;cancelAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=none;fontSize=22;strokeColor=#000000;fillColor=#ffffff;align=left;arcSize=9;" parent="GkP1prsd0XOYrcYADEeq-1" vertex="1">
          <mxGeometry x="1000" y="750" width="800" height="570" as="geometry" />
        </mxCell>
        <mxCell id="5fQTfYabW9B-tewhtZIN-0" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;tryAcquire&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Thread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;currentThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;!&lt;/span&gt;&lt;span style=&quot;&quot;&gt;hasQueuedPredecessors&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;+ &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;lt; &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;throw new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;Error&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&quot;Maximum lock count exceeded&quot;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=14;align=left;" vertex="1" parent="GkP1prsd0XOYrcYADEeq-1">
          <mxGeometry x="10" y="120" width="620" height="555" as="geometry" />
        </mxCell>
        <mxCell id="5fQTfYabW9B-tewhtZIN-1" value="" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=14;fontColor=#000000;align=left;" vertex="1" parent="GkP1prsd0XOYrcYADEeq-1">
          <mxGeometry x="540" y="1580" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="5fQTfYabW9B-tewhtZIN-5" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span&gt;nonfairTryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;nonfairTryAcquire&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Thread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;currentThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;+ &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;lt; &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// overflow&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;throw new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;Error&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&quot;Maximum lock count exceeded&quot;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=14;align=left;arcSize=10;" vertex="1" parent="GkP1prsd0XOYrcYADEeq-1">
          <mxGeometry x="10" y="790" width="630" height="540" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="m-LhpGy6pDTVkrjs-Amt" name="(读写锁)加锁">
    <mxGraphModel dx="2514" dy="1325" grid="0" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="4000" pageHeight="5000" math="0" shadow="0">
      <root>
        <mxCell id="4Kn29drxNQvWNtrvnITc-0" />
        <mxCell id="4Kn29drxNQvWNtrvnITc-1" parent="4Kn29drxNQvWNtrvnITc-0" />
        <mxCell id="4Kn29drxNQvWNtrvnITc-2" value="读写锁实现" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;glass=0;labelBackgroundColor=none;fontSize=30;fontColor=#000000;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="2270" y="410" width="190" height="40" as="geometry" />
        </mxCell>
        <mxCell id="VO5wA90HG24xElYhcVth-9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.998;entryY=0.541;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="C6gt7NBxkSrmRmRFl4JR-8" target="C6gt7NBxkSrmRmRFl4JR-13">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="VO5wA90HG24xElYhcVth-10" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="C6gt7NBxkSrmRmRFl4JR-8" target="C6gt7NBxkSrmRmRFl4JR-14">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="C6gt7NBxkSrmRmRFl4JR-8" value="共用&lt;br&gt;Sync" style="html=1;whiteSpace=wrap;aspect=fixed;shape=isoRectangle;rounded=0;glass=0;labelBackgroundColor=#ffffff;fontSize=16;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;align=center;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="3874" y="1319" width="115.01" height="69" as="geometry" />
        </mxCell>
        <mxCell id="2I2go7Ke-rsbTxs8lcRy-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="C6gt7NBxkSrmRmRFl4JR-12" target="Z4jG9dqAK4cvpMTp8F6e-6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="C6gt7NBxkSrmRmRFl4JR-12" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;lock&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;sync&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;acquireShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=16;strokeColor=#000000;fillColor=#ffffff;align=left;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="2326" y="2394" width="303" height="124" as="geometry" />
        </mxCell>
        <mxCell id="2I2go7Ke-rsbTxs8lcRy-0" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="C6gt7NBxkSrmRmRFl4JR-13" target="C6gt7NBxkSrmRmRFl4JR-12">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="C6gt7NBxkSrmRmRFl4JR-13" value="&lt;p style=&quot;margin: 0px ; margin-top: 4px ; text-align: center&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;Class&amp;gt;&amp;gt;&lt;/i&gt;&lt;br&gt;&lt;b&gt;ReadLock&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;+&amp;nbsp;&amp;nbsp;sync: Sync extends AQS&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ void lock();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ void lockInterruptibly() throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ boolean tryLock();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ boolean tryLock(long time, TimeUnit unit) throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;span style=&quot;font-size: x-small&quot;&gt;+ void unlock();&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;rounded=0;glass=0;labelBackgroundColor=#ffffff;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="2973.5" y="1262" width="450" height="170" as="geometry" />
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=16;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="C6gt7NBxkSrmRmRFl4JR-14" target="2I2go7Ke-rsbTxs8lcRy-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="C6gt7NBxkSrmRmRFl4JR-14" value="&lt;p style=&quot;margin: 0px ; margin-top: 4px ; text-align: center&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;Interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br&gt;&lt;b&gt;WriteLock&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;+&amp;nbsp;&amp;nbsp;sync: Sync extends AQS&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ void lock();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ void lockInterruptibly() throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ boolean tryLock();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ boolean tryLock(long time, TimeUnit unit) throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;span style=&quot;font-size: x-small&quot;&gt;+ void unlock();&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;rounded=0;glass=0;labelBackgroundColor=#ffffff;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="4287" y="1269" width="450" height="170" as="geometry" />
        </mxCell>
        <mxCell id="VO5wA90HG24xElYhcVth-1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="lFT8Ks_veNPhik5HumSQ-1" target="C6gt7NBxkSrmRmRFl4JR-13">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3589.5" y="1125" />
              <mxPoint x="3198.5" y="1125" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="VO5wA90HG24xElYhcVth-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.531;entryY=-0.024;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="lFT8Ks_veNPhik5HumSQ-1" target="C6gt7NBxkSrmRmRFl4JR-14">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3590" y="1138" />
              <mxPoint x="4526" y="1138" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="lFT8Ks_veNPhik5HumSQ-1" value="&lt;p style=&quot;margin: 0px ; margin-top: 4px ; text-align: center&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;Interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br&gt;&lt;b&gt;Lock&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;+&amp;nbsp;&amp;nbsp;sync: Sync extends AQS&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ void lock();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ void lockInterruptibly() throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ boolean tryLock();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ boolean tryLock(long time, TimeUnit unit) throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;span style=&quot;font-size: x-small&quot;&gt;+ void unlock();&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;rounded=0;glass=0;labelBackgroundColor=#ffffff;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="3364.83" y="908" width="450" height="170" as="geometry" />
        </mxCell>
        <mxCell id="VO5wA90HG24xElYhcVth-0" value="&lt;p style=&quot;margin: 0px ; margin-top: 4px ; text-align: center&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;Interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br&gt;&lt;b&gt;ReentrantReadWriteLock&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;+ readerLock: ReadLock&amp;nbsp;implement Lock&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;+ writerLock: WriteLock implement Lock&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;+ readLock(): ReadLock&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;+ writeLock(): WriteLock&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;rounded=0;glass=0;labelBackgroundColor=#ffffff;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="3496.5" y="1169" width="290" height="160" as="geometry" />
        </mxCell>
        <mxCell id="Z4jG9dqAK4cvpMTp8F6e-5" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;static final class &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;FairSync &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;extends &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Sync &lt;/span&gt;&lt;span&gt;{&lt;/span&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;writerShouldBlock&lt;/span&gt;&lt;span&gt;() {//写线程是否应该阻塞&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span&gt;hasQueuedPredecessors&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;//如果排队队列不为空，&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;&lt;span&gt;	&lt;/span&gt;并且排在队头的节点线程不是当前准备抢锁的写线程，那么需要阻塞&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;readerShouldBlock&lt;/span&gt;&lt;span&gt;() {&lt;/span&gt;//读线程是否应该阻塞&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span&gt;hasQueuedPredecessors&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;/span&gt;//如果排队队列不为空，&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;	并且排在队头的节点线程不是当前准备抢锁的读线程，那么需要阻塞&lt;/pre&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;align=left;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="3908" y="2172" width="621" height="401" as="geometry" />
        </mxCell>
        <mxCell id="2I2go7Ke-rsbTxs8lcRy-3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="Z4jG9dqAK4cvpMTp8F6e-6" target="Z4jG9dqAK4cvpMTp8F6e-7">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-1" value="&lt;pre style=&quot;color: rgb(0 , 0 , 0) ; text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;tryAcquireShared()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=16;fontColor=#FF0000;" vertex="1" connectable="0" parent="2I2go7Ke-rsbTxs8lcRy-3">
          <mxGeometry x="-0.2825" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2I2go7Ke-rsbTxs8lcRy-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="Z4jG9dqAK4cvpMTp8F6e-6" target="2I2go7Ke-rsbTxs8lcRy-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-2" value="&lt;pre style=&quot;color: rgb(0 , 0 , 0) ; text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;doAcquireShared()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=16;fontColor=#FF0000;" vertex="1" connectable="0" parent="2I2go7Ke-rsbTxs8lcRy-4">
          <mxGeometry x="0.5116" y="-3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Z4jG9dqAK4cvpMTp8F6e-6" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;共享锁,模板方法&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;Semaphore，CountDownLatch,ReentrantReadWriteLock&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;均有实现&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public final void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquireShared&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;tryAcquireShared&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;) &lt;/span&gt;&lt;span&gt;&amp;lt; &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;)&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;doAcquireShared&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;align=left;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="2232" y="2573" width="516" height="260" as="geometry" />
        </mxCell>
        <mxCell id="VkflFZi93BrO_o7EnHx4-1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=16;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="Z4jG9dqAK4cvpMTp8F6e-7" target="VkflFZi93BrO_o7EnHx4-0">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Z4jG9dqAK4cvpMTp8F6e-7" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;protected final int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryAcquireShared&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;unused&lt;/span&gt;) {&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * Walkthrough:&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * 1. If write lock held by another thread, fail.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * 2. Otherwise, this thread is eligible for&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    lock wrt state, so ask if it should block&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    because of queue policy. If not, try&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    to grant by CASing state and updating count.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    Note that step does not check for reentrant&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    acquires, which is postponed to full version&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    to avoid having to check hold count in&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    the more typical non-reentrant case.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * 3. If step 2 fails either because thread&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    apparently not eligible or CAS fails or count&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    saturated, chain to version with full retry loop.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;= &lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;.currentThread();&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;= getState();&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(exclusiveCount(&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;) != 0 &amp;amp;&amp;amp;&lt;br&gt;        getExclusiveOwnerThread() != &lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;)&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;-1;&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;r &lt;/span&gt;= sharedCount(&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;);&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;font color=&quot;#cc0000&quot;&gt;!&lt;span style=&quot;font-weight: bold&quot;&gt;readerShouldBlock&lt;/span&gt;()&lt;/font&gt; &amp;amp;&amp;amp;//公平与非公平实现的差异在这里&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;r &lt;/span&gt;&amp;lt; MAX_COUNT &amp;amp;&amp;amp;&lt;br&gt;        compareAndSetState(&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;, &lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;+ SHARED_UNIT)) {//CAS拿读锁，&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        高16位加1&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;r &lt;/span&gt;== 0) {//r在CAS之前等于0表示，当前是第一个获取读锁的线程&lt;br&gt;            firstReader = &lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;;&lt;br&gt;            firstReaderHoldCount = 1;&lt;br&gt;        } &lt;span style=&quot;font-weight: bold&quot;&gt;else if &lt;/span&gt;(firstReader == &lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;) {//不是第一个获取读锁的线程&lt;br&gt;            firstReaderHoldCount++;&lt;br&gt;        } &lt;span style=&quot;font-weight: bold&quot;&gt;else &lt;/span&gt;{&lt;br&gt;            &lt;span style=&quot;font-weight: bold&quot;&gt;HoldCounter &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;= cachedHoldCounter;&lt;br&gt;            &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;== &lt;span style=&quot;font-weight: bold&quot;&gt;null &lt;/span&gt;|| &lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;.tid != getThreadId(&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;))&lt;br&gt;                cachedHoldCounter = &lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;= readHolds.get();&lt;br&gt;            &lt;span style=&quot;font-weight: bold&quot;&gt;else if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;.count == 0)&lt;br&gt;                readHolds.set(&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;);&lt;br&gt;            &lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;.count++;&lt;br&gt;        }&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;1;&lt;br&gt;    }&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;fullTryAcquireShared(&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;);&lt;font color=&quot;#cc0000&quot;&gt;//上面拿锁失败，进入这个方法&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;font color=&quot;#cc0000&quot;&gt;不断自旋拿读锁&lt;/font&gt;&lt;br&gt;}&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;align=left;arcSize=9;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="1808" y="2975" width="697" height="990" as="geometry" />
        </mxCell>
        <mxCell id="TUMVNPgcMENQiV9ykWhL-6" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;static final class &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;NonfairSync &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;extends &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Sync &lt;/span&gt;{&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;writerShouldBlock&lt;/span&gt;() {&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;return false&lt;/span&gt;;&lt;span style=&quot;font-style: italic&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;}&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;readerShouldBlock&lt;/span&gt;() {&lt;span style=&quot;font-style: italic&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;apparentlyFirstQueuedIsExclusive();&lt;br&gt;    }&lt;br&gt;}&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;align=left;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="3341" y="2196" width="525" height="244" as="geometry" />
        </mxCell>
        <mxCell id="2I2go7Ke-rsbTxs8lcRy-1" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;private void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;doAcquireShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;addWaiter&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;SHARED)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;try &lt;/span&gt;&lt;span style=&quot;&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interrupted &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;for &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;predecessor&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;head&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;r &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;tryAcquireShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;r &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setHeadAndPropagate&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;r&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;next &lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;; &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// help GC&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interrupted&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;selfInterrupt&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;shouldParkAfterFailedAcquire&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;&quot;&gt;parkAndCheckInterrupt&lt;/span&gt;&lt;span style=&quot;&quot;&gt;())&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interrupted &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    } &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;finally &lt;/span&gt;&lt;span style=&quot;&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;cancelAcquire&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=14;align=left;arcSize=9;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="2778" y="2994" width="725" height="888" as="geometry" />
        </mxCell>
        <mxCell id="2I2go7Ke-rsbTxs8lcRy-5" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;lock&lt;/span&gt;&lt;span&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;sync&lt;span&gt;.&lt;/span&gt;&lt;span&gt;acquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;//走互斥锁流程&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=14;align=left;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="4737" y="1661" width="355" height="107" as="geometry" />
        </mxCell>
        <mxCell id="rJTA5NB_A3fbP47ulosW-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=14;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="2I2go7Ke-rsbTxs8lcRy-6" target="rJTA5NB_A3fbP47ulosW-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2I2go7Ke-rsbTxs8lcRy-6" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;b&gt;写锁是互斥锁，和互斥锁的流程一样，都是基于AQS的模板方法，&lt;/b&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;b&gt;区别在与tryAcquire()&lt;/b&gt;&lt;b style=&quot;font-size: 12.8pt ; white-space: normal&quot;&gt;方法的实现上&lt;/b&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public final void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;!&lt;/span&gt;&lt;span&gt;tryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;) &lt;/span&gt;&lt;span&gt;&amp;amp;&amp;amp;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;acquireQueued&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;addWaiter&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;EXCLUSIVE)&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;))&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;selfInterrupt&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=14;align=left;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="4705.75" y="1940" width="591" height="251" as="geometry" />
        </mxCell>
        <mxCell id="rJTA5NB_A3fbP47ulosW-1" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryAcquire&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;) {&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * Walkthrough:&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * 1. If read count nonzero or write count nonzero&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    and owner is a different thread, fail.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * 2. If count would saturate, fail. (This can only&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    happen if count is already nonzero.)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * 3. Otherwise, this thread is eligible for lock if&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    it is either a reentrant acquire or&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    queue policy allows it. If so, update state&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    and set owner.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;= &lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;.currentThread();&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;= getState();&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;w &lt;/span&gt;= exclusiveCount(&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;);//表示&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;!= 0) {//有线程持有锁（读锁或者写锁）&lt;br&gt;        &lt;span style=&quot;font-style: italic&quot;&gt;// (Note: if c != 0 and w == 0 then shared count != 0)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;w &lt;/span&gt;== 0 || &lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;!= getExclusiveOwnerThread())&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;white-space: pre&quot;&gt;	&lt;/span&gt;//w=0表示读线程占有锁，w!=0表示写线程占有锁，如果是写线程占有锁，&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;得看看是不是当前线程&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;span style=&quot;font-weight: bold&quot;&gt;return false&lt;/span&gt;;&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;w &lt;/span&gt;+ exclusiveCount(&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;) &amp;gt; MAX_COUNT)&lt;br&gt;            &lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;Error(&quot;Maximum lock count exceeded&quot;);&lt;br&gt;        &lt;span style=&quot;font-style: italic&quot;&gt;// Reentrant acquire&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;        &lt;/span&gt;setState(&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;+ &lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;);&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;return true&lt;/span&gt;;&lt;br&gt;    }&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;//能走到这里，表示c=0,没有线程持有锁&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;font color=&quot;#ff0000&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;writerShouldBlock&lt;/span&gt;()&lt;/font&gt; ||&lt;br&gt;        !compareAndSetState(&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;, &lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;+ &lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;))&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;return false&lt;/span&gt;;&lt;br&gt;    setExclusiveOwnerThread(&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;);&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;return true&lt;/span&gt;;&lt;br&gt;}&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=14;align=left;arcSize=8;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="4675" y="2299" width="684" height="893" as="geometry" />
        </mxCell>
        <mxCell id="LARzN_jPg7y_6yzF4rrd-0" value="&lt;span style=&quot;font-size: 16px;&quot;&gt;读写锁和互斥锁的内部都定义了一个Sync内部类，继承AQS&lt;/span&gt;" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.cloud_callout;labelBackgroundColor=#ffffff;fontSize=16;align=left;fontColor=#FF3333;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="3958" y="1206" width="230" height="122" as="geometry" />
        </mxCell>
        <mxCell id="LARzN_jPg7y_6yzF4rrd-2" value="&lt;font style=&quot;font-size: 16px&quot;&gt;注意：&lt;br&gt;互斥锁的tryAcquire()分公平和非公平实现，读写锁的tryAcquire()不区分&lt;/font&gt;" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.cloud_callout;labelBackgroundColor=#ffffff;fontSize=14;align=left;fontColor=#FF3333;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="5352.75" y="2000" width="305" height="161" as="geometry" />
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-0" value="注意：&lt;br&gt;读写锁的&lt;span style=&quot;font-family: &amp;quot;pt mono&amp;quot; ; font-size: 12.8pt&quot;&gt;tryAcquireShared()方法&lt;br&gt;不区分公平和非公平实现&lt;/span&gt;" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.cloud_callout;labelBackgroundColor=#ffffff;fontSize=16;align=left;fontColor=#FF0000;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="2748" y="2429" width="345" height="161" as="geometry" />
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-4" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;ReadLock和WriteLock共用一个Sync 对象，ReentrantReadWriteLock内部&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;维护一个Sync对象，ReentrantLock内部也维护一个Sync对象，均继承AQS&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ReentrantReadWriteLock&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;fair&lt;/span&gt;) {&lt;br&gt;    sync = &lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;fair &lt;/span&gt;? &lt;span style=&quot;font-weight: bold&quot;&gt;new &lt;/span&gt;FairSync() : &lt;span style=&quot;font-weight: bold&quot;&gt;new &lt;/span&gt;NonfairSync();&lt;br&gt;    readerLock = &lt;span style=&quot;font-weight: bold&quot;&gt;new &lt;/span&gt;ReadLock(&lt;span style=&quot;font-weight: bold&quot;&gt;this&lt;/span&gt;);&lt;br&gt;    writerLock = &lt;span style=&quot;font-weight: bold&quot;&gt;new &lt;/span&gt;WriteLock(&lt;span style=&quot;font-weight: bold&quot;&gt;this&lt;/span&gt;);&lt;br&gt;}&lt;/pre&gt;" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.rectCallout;dx=30;dy=15;boundedLbl=1;labelBackgroundColor=#ffffff;fontSize=16;fontColor=#000000;align=left;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="3891" y="815" width="648" height="276" as="geometry" />
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=16;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="iOsgHEEnQ7MRM6_jHvUU-5" target="TUMVNPgcMENQiV9ykWhL-6">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3893" y="2121" />
              <mxPoint x="3635" y="2121" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=16;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="iOsgHEEnQ7MRM6_jHvUU-5" target="Z4jG9dqAK4cvpMTp8F6e-5">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3894" y="2121" />
              <mxPoint x="4168" y="2121" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-5" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;&lt;br class=&quot;Apple-interchange-newline&quot;&gt;abstract static class &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Sync &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;extends &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;AbstractQueuedSynchronizer &lt;/span&gt;{&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;private static final long &lt;/span&gt;serialVersionUID = 6317671515068378041L;&lt;br&gt;&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/*&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;     *同互斥锁一样，读写锁也是用state变量来表示锁状态的。&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;     *只是state变量在这里的含义和互斥锁完全不同。&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;     *同互斥锁一样，读写锁也是用state变量来表示锁状态的。只是state变量在这里的含义和互斥锁完全不同。&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;     *在内部类Sync中，对state变量进行了重新定义，分高16位和低16位（一个int类型4个字节）,&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;     *高16位表示读锁重入次数，低16位表示写锁重入次数&lt;span style=&quot;font-style: italic&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;static final int &lt;/span&gt;SHARED_SHIFT   = 16;&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;static final int &lt;/span&gt;SHARED_UNIT    = (1 &amp;lt;&amp;lt; SHARED_SHIFT);&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;static final int &lt;/span&gt;MAX_COUNT      = (1 &amp;lt;&amp;lt; SHARED_SHIFT) - 1;&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;static final int &lt;/span&gt;EXCLUSIVE_MASK = (1 &amp;lt;&amp;lt; SHARED_SHIFT) - 1;&lt;br&gt;&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/** Returns the number of shared holds represented in count  */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;static int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;sharedCount&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;c&lt;/span&gt;)    { &lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;c &lt;/span&gt;&amp;gt;&amp;gt;&amp;gt; SHARED_SHIFT; }&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/** Returns the number of exclusive holds represented in count  */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;static int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;exclusiveCount&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;c&lt;/span&gt;) { &lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;c &lt;/span&gt;&amp;amp; EXCLUSIVE_MASK; }&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=16;fontColor=#000000;align=left;arcSize=10;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="3448" y="1455" width="890" height="617" as="geometry" />
        </mxCell>
        <mxCell id="VkflFZi93BrO_o7EnHx4-0" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;final int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;fullTryAcquireShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * This code is in part redundant with that in&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * tryAcquireShared but is simpler overall by not&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * complicating tryAcquireShared with interactions between&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * retries and lazily reading hold counts.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;HoldCounter &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;for &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;exclusiveCount&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;getExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// else we hold the exclusive lock; blocking here&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;            // would cause deadlock.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;} &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;readerShouldBlock&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// Make sure we&#39;re not acquiring read lock reentrantly&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;firstReader &lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// assert firstReaderHoldCount &amp;gt; 0;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;} &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else &lt;/span&gt;&lt;span style=&quot;&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;cachedHoldCounter&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;|| &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;tid &lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getThreadId&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;readHolds&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;get&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;count &lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                            &lt;/span&gt;readHolds&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;remove&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;count &lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;sharedCount&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;MAX_COUNT)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;throw new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;Error&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&quot;Maximum lock count exceeded&quot;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;+ &lt;/span&gt;&lt;span style=&quot;&quot;&gt;SHARED_UNIT)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;sharedCount&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;firstReader &lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;firstReaderHoldCount &lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;} &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;firstReader &lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;firstReaderHoldCount&lt;span style=&quot;&quot;&gt;++&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;} &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else &lt;/span&gt;&lt;span style=&quot;&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;cachedHoldCounter&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;|| &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;tid &lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getThreadId&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;readHolds&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;get&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;count &lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;readHolds&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;set&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;count&lt;span style=&quot;&quot;&gt;++&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;cachedHoldCounter &lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;; &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// cache for release&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=16;align=left;arcSize=4;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="1789" y="4045" width="735" height="1170" as="geometry" />
        </mxCell>
        <mxCell id="VkflFZi93BrO_o7EnHx4-2" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;quot;pt mono&amp;quot; ; font-size: 12.8pt&quot;&gt;&lt;font color=&quot;#cc0000&quot;&gt;不断自旋拿读锁&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;labelBackgroundColor=none;fontSize=16;fontColor=#000000;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="2161" y="3989" width="133" height="33" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="QDP8r3jRsx4bfRsVqRZF" name="(读写锁)释放锁">
    <mxGraphModel dx="2514" dy="1325" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="5000" pageHeight="3000" math="0" shadow="0">
      <root>
        <mxCell id="RbbWNVs1ZPorfGrst1G5-0" />
        <mxCell id="RbbWNVs1ZPorfGrst1G5-1" parent="RbbWNVs1ZPorfGrst1G5-0" />
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" edge="1" parent="RbbWNVs1ZPorfGrst1G5-1" source="teO8W70LR5i9nKHsj_jc-0" target="teO8W70LR5i9nKHsj_jc-2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-0" value="释放读锁" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;labelBackgroundColor=none;fontSize=18;fontColor=#000000;" vertex="1" parent="RbbWNVs1ZPorfGrst1G5-1">
          <mxGeometry x="626" y="279" width="106" height="27" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" edge="1" parent="RbbWNVs1ZPorfGrst1G5-1" source="teO8W70LR5i9nKHsj_jc-1" target="teO8W70LR5i9nKHsj_jc-3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-1" value="释放写锁" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;labelBackgroundColor=none;fontSize=18;fontColor=#000000;" vertex="1" parent="RbbWNVs1ZPorfGrst1G5-1">
          <mxGeometry x="2277" y="279" width="106" height="27" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.48;entryY=-0.005;entryDx=0;entryDy=0;entryPerimeter=0;fontSize=18;fontColor=#000000;" edge="1" parent="RbbWNVs1ZPorfGrst1G5-1" source="teO8W70LR5i9nKHsj_jc-2" target="HiDBwtyS9m8kqqCNAFJG-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-2" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;unlock&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;sync&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;releaseShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=16;align=left;" vertex="1" parent="RbbWNVs1ZPorfGrst1G5-1">
          <mxGeometry x="539" y="360" width="280" height="119" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-0" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" edge="1" parent="RbbWNVs1ZPorfGrst1G5-1" source="teO8W70LR5i9nKHsj_jc-3" target="teO8W70LR5i9nKHsj_jc-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-3" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;unlock&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;sync&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;release&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=16;align=left;" vertex="1" parent="RbbWNVs1ZPorfGrst1G5-1">
          <mxGeometry x="2210" y="360" width="237" height="112" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-4" value="写锁是互斥锁，&lt;br&gt;流程和互斥锁一样" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.cloud_callout;labelBackgroundColor=none;fontSize=16;fontColor=#000000;align=left;" vertex="1" parent="RbbWNVs1ZPorfGrst1G5-1">
          <mxGeometry x="2470" y="290" width="162" height="120" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;entryX=0.588;entryY=0.007;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="RbbWNVs1ZPorfGrst1G5-1" source="teO8W70LR5i9nKHsj_jc-5" target="teO8W70LR5i9nKHsj_jc-6">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1623" y="1058" as="targetPoint" />
            <Array as="points">
              <mxPoint x="2338" y="946" />
              <mxPoint x="1860" y="946" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-8" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;tryRelease()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=18;fontColor=#000000;" vertex="1" connectable="0" parent="teO8W70LR5i9nKHsj_jc-7">
          <mxGeometry x="0.0206" y="2" relative="1" as="geometry">
            <mxPoint x="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" edge="1" parent="RbbWNVs1ZPorfGrst1G5-1" source="teO8W70LR5i9nKHsj_jc-5" target="teO8W70LR5i9nKHsj_jc-10">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2339" y="946" />
              <mxPoint x="2627" y="946" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-12" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;unparkSuccessor()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=18;fontColor=#000000;" vertex="1" connectable="0" parent="teO8W70LR5i9nKHsj_jc-11">
          <mxGeometry x="-0.0505" y="2" relative="1" as="geometry">
            <mxPoint y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-5" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;release&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;tryRelease&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;head&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;waitStatus &lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;unparkSuccessor&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;" vertex="1" parent="RbbWNVs1ZPorfGrst1G5-1">
          <mxGeometry x="2044" y="583" width="569" height="285" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-6" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;tryRelease&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;releases&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;!&lt;/span&gt;&lt;span style=&quot;&quot;&gt;isHeldExclusively&lt;/span&gt;&lt;span style=&quot;&quot;&gt;())&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;throw new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;IllegalMonitorStateException&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() &lt;/span&gt;&lt;span style=&quot;&quot;&gt;- &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;releases&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;free &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;exclusiveCount&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;free&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;free&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;arcSize=9;" vertex="1" parent="RbbWNVs1ZPorfGrst1G5-1">
          <mxGeometry x="1532" y="1080" width="558" height="280" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-10" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;private void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;unparkSuccessor&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * If status is negative (i.e., possibly needing signal) try&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * to clear in anticipation of signalling.  It is OK if this&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * fails or if status is changed by waiting thread.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;waitStatus&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;lt; &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetWaitStatus&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * Thread to unpark is held in successor, which is normally&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * just the next node.  But if cancelled or apparently null,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * traverse backwards from tail to find the actual&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * non-cancelled successor.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;next&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;|| &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;waitStatus &lt;span style=&quot;&quot;&gt;&amp;gt; &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;for &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;tail&lt;span style=&quot;&quot;&gt;; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;prev&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;waitStatus &lt;span style=&quot;&quot;&gt;&amp;lt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;LockSupport&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;unpark&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;thread&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;arcSize=7;" vertex="1" parent="RbbWNVs1ZPorfGrst1G5-1">
          <mxGeometry x="2277" y="1082" width="666" height="610" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" edge="1" parent="RbbWNVs1ZPorfGrst1G5-1" source="HiDBwtyS9m8kqqCNAFJG-1" target="HiDBwtyS9m8kqqCNAFJG-2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-9" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;tryReleaseShared()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=18;fontColor=#000000;" vertex="1" connectable="0" parent="HiDBwtyS9m8kqqCNAFJG-4">
          <mxGeometry x="-0.0354" y="2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=18;fontColor=#000000;" edge="1" parent="RbbWNVs1ZPorfGrst1G5-1" source="HiDBwtyS9m8kqqCNAFJG-1" target="HiDBwtyS9m8kqqCNAFJG-3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-10" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;doReleaseShared()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=18;fontColor=#000000;" vertex="1" connectable="0" parent="HiDBwtyS9m8kqqCNAFJG-5">
          <mxGeometry x="0.0903" y="-1" relative="1" as="geometry">
            <mxPoint y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-1" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;releaseShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;tryReleaseShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;doReleaseShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;" vertex="1" parent="RbbWNVs1ZPorfGrst1G5-1">
          <mxGeometry x="442" y="550" width="492" height="221" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-2" value="&lt;pre&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold ; font-style: italic&quot;&gt;tryReleaseShared&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold ; font-style: italic&quot;&gt;unused&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;Thread&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;currentThread&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;firstReader &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;// assert firstReaderHoldCount &amp;gt; 0;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;firstReaderHoldCount &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;firstReader &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;else&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;            &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;firstReaderHoldCount&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;--&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;} &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;else &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;HoldCounter &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;cachedHoldCounter&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;|| &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;tid &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;getThreadId&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;readHolds&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;get&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;count &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;count&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;count &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&amp;lt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;readHolds&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;remove&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;count &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&amp;lt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;throw &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;unmatchedUnlockException&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;--&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;count&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;for &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;;&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;) {&lt;font color=&quot;#ff0000&quot;&gt;//&lt;/font&gt;&lt;/span&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;&lt;font color=&quot;#ff0000&quot;&gt;因为读锁是共享锁，多个线程会同时持有读锁，&lt;/font&gt;&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;&lt;font color=&quot;#ff0000&quot;&gt;所以对读锁的释放不能直接减1，而是需要通过一个for循环+CAS操作不断重试。&lt;/font&gt;&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;getState&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;- &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;SHARED_UNIT&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;compareAndSetState&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;// Releasing the read lock has no effect on readers,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;            // but it may allow waiting writers to proceed if&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;            // both read and write locks are now free.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;arcSize=8;" vertex="1" parent="RbbWNVs1ZPorfGrst1G5-1">
          <mxGeometry x="33" y="1038" width="667" height="812" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-3" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;private void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;doReleaseShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * Ensure that a release propagates, even if there are other&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * in-progress acquires/releases.  This proceeds in the usual&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * way of trying to unparkSuccessor of head if it needs&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * signal. But if it does not, status is set to PROPAGATE to&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * ensure that upon release, propagation continues.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * Additionally, we must loop in case a new node is added&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * while we are doing this. Also, unlike other uses of&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * unparkSuccessor, we need to know if CAS to reset status&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * fails, if so rechecking.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;for &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;head&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;tail&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;waitStatus&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;SIGNAL) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;!&lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetWaitStatus&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;SIGNAL&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;continue&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;            &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// loop to recheck cases&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;&quot;&gt;unparkSuccessor&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0 &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                     !&lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetWaitStatus&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;PROPAGATE))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;continue&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;                &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// loop on failed CAS&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;head&lt;span style=&quot;&quot;&gt;)                   &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// loop if head changed&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;arcSize=7;" vertex="1" parent="RbbWNVs1ZPorfGrst1G5-1">
          <mxGeometry x="757" y="1038" width="713" height="702" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram name="(读写锁)中断锁 " id="ldpvKLvwOpZEDC9SE9Ql">
    <mxGraphModel dx="2514" dy="1325" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="o9VDTlM6Sd9dmmWb7DFp-0" />
        <mxCell id="o9VDTlM6Sd9dmmWb7DFp-1" parent="o9VDTlM6Sd9dmmWb7DFp-0" />
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="J9Tmd6Zy7u8FUA9VIpDE" name="模板">
    <mxGraphModel dx="1554" dy="969" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="8500" pageHeight="20000" math="0" shadow="0">
      <root>
        <mxCell id="tAtp5M9JWyRdrx9-1-cH-0" />
        <mxCell id="tAtp5M9JWyRdrx9-1-cH-1" parent="tAtp5M9JWyRdrx9-1-cH-0" />
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-0" value="Object" style="html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=2;fontFamily=Verdana;fontSize=12;align=center;shape=mxgraph.ios7ui.horLines;" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1272.5" y="656" width="135" height="50" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-1" value="Function" style="swimlane;html=1;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#e0e0e0;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;align=center;rounded=1;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fontFamily=Verdana;fontSize=12" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1260" y="290" width="160" height="110" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-2" value="Row 1" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-1" vertex="1">
          <mxGeometry y="26" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-3" value="Row 2" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-1" vertex="1">
          <mxGeometry y="52" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-4" value="Row 3" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-1" vertex="1">
          <mxGeometry y="78" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-5" value="Function" style="swimlane;html=1;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#e0e0e0;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;align=center;rounded=1;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fontFamily=Verdana;fontSize=12" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1660" y="290" width="160" height="130" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-6" value="Row 1" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-5" vertex="1">
          <mxGeometry y="26" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-7" value="Row 2" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-5" vertex="1">
          <mxGeometry y="52" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-8" value="Row 3" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-5" vertex="1">
          <mxGeometry y="78" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-9" value="Row 4" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-5" vertex="1">
          <mxGeometry y="104" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-10" value="Function" style="swimlane;html=1;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#e0e0e0;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;align=center;rounded=1;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fontFamily=Verdana;fontSize=12" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1260" y="482" width="160" height="110" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-11" value="Row 1" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-10" vertex="1">
          <mxGeometry y="26" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-12" value="Row 2" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-10" vertex="1">
          <mxGeometry y="52" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-13" value="Row 3" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-10" vertex="1">
          <mxGeometry y="78" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-14" value="Function" style="swimlane;html=1;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#e0e0e0;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;align=center;rounded=1;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fontFamily=Verdana;fontSize=12" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1260" y="786" width="160" height="140" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-15" value="Row 1" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-14" vertex="1">
          <mxGeometry y="26" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-16" value="Row 2" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-14" vertex="1">
          <mxGeometry y="52" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-17" value="Row 3" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-14" vertex="1">
          <mxGeometry y="78" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-18" value="Row 4" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-14" vertex="1">
          <mxGeometry y="104" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-19" value="Function" style="swimlane;html=1;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#e0e0e0;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;align=center;rounded=1;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fontFamily=Verdana;fontSize=12" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1660" y="482" width="160" height="84" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-20" value="Row 1" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-19" vertex="1">
          <mxGeometry y="26" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-21" value="Row 2" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-19" vertex="1">
          <mxGeometry y="52" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-22" value="Function" style="swimlane;html=1;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#e0e0e0;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;align=center;rounded=1;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fontFamily=Verdana;fontSize=12" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1660" y="786" width="160" height="110" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-23" value="Row 1" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-22" vertex="1">
          <mxGeometry y="26" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-24" value="Row 2" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-22" vertex="1">
          <mxGeometry y="52" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-25" value="Row 3" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-22" vertex="1">
          <mxGeometry y="78" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-26" value="Object" style="html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=2;fontFamily=Verdana;fontSize=12;align=center;shape=mxgraph.ios7ui.horLines;" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1480" y="656" width="135" height="50" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-27" style="edgeStyle=none;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-14" target="AeLNYvw3zZ7ImW0hco7L-0" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-28" style="edgeStyle=none;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-0" target="AeLNYvw3zZ7ImW0hco7L-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-29" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;exitX=1;exitY=0.25;entryX=1;entryY=0.5;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-14" target="AeLNYvw3zZ7ImW0hco7L-13" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1450" y="821" />
              <mxPoint x="1450" y="573" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-30" value="" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-26" target="AeLNYvw3zZ7ImW0hco7L-23" edge="1">
          <mxGeometry x="-0.1342" y="32" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-31" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-10" target="AeLNYvw3zZ7ImW0hco7L-26" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1548" y="556" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-32" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-1" target="AeLNYvw3zZ7ImW0hco7L-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-33" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-22" target="AeLNYvw3zZ7ImW0hco7L-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-34" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-5" target="AeLNYvw3zZ7ImW0hco7L-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-35" style="edgeStyle=orthogonalEdgeStyle;html=1;entryX=0;entryY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;exitX=1;exitY=0.5;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-3" target="AeLNYvw3zZ7ImW0hco7L-7" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-36" style="edgeStyle=orthogonalEdgeStyle;html=1;exitX=0;exitY=0.5;entryX=1;entryY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-6" target="AeLNYvw3zZ7ImW0hco7L-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-37" style="edgeStyle=orthogonalEdgeStyle;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-4" target="AeLNYvw3zZ7ImW0hco7L-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-38" style="edgeStyle=orthogonalEdgeStyle;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-12" target="AeLNYvw3zZ7ImW0hco7L-21" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-39" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-21" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1980" y="547" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-40" style="edgeStyle=orthogonalEdgeStyle;html=1;exitX=1;exitY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-23" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1980" y="825" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-41" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;entryX=1;entryY=0.5;" parent="tAtp5M9JWyRdrx9-1-cH-1" target="AeLNYvw3zZ7ImW0hco7L-24" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1990" y="835" as="targetPoint" />
            <mxPoint x="1980" y="851" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="1980" y="851" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-42" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;entryX=1;entryY=0.5;" parent="tAtp5M9JWyRdrx9-1-cH-1" target="AeLNYvw3zZ7ImW0hco7L-25" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1830.1904761904761" y="861.0952380952381" as="targetPoint" />
            <mxPoint x="1980" y="877" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="1900" y="877" />
              <mxPoint x="1900" y="877" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-43" style="edgeStyle=orthogonalEdgeStyle;html=1;exitX=1;exitY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-6" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1980" y="329" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-44" style="edgeStyle=orthogonalEdgeStyle;html=1;exitX=1;exitY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-7" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1980" y="355" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-45" style="edgeStyle=orthogonalEdgeStyle;html=1;exitX=1;exitY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-8" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1980" y="381" as="targetPoint" />
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-46" style="edgeStyle=elbowEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;elbow=vertical;entryX=1.011;entryY=0.152;entryPerimeter=0;" parent="tAtp5M9JWyRdrx9-1-cH-1" target="AeLNYvw3zZ7ImW0hco7L-5" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1840" y="305" as="targetPoint" />
            <mxPoint x="1980" y="310" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="1910" y="310" />
            </Array>
          </mxGeometry>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
