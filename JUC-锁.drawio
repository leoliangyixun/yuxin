<mxfile host="app.diagrams.net" modified="2021-07-06T11:31:31.209Z" agent="5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.114 Safari/537.36" etag="gaQQfhdNAi57XlrY8_Sp" version="14.8.4" type="github" pages="9">
  <diagram name="互斥锁" id="5d7acffa-a066-3a61-03fe-96351882024d">
    <mxGraphModel dx="2514" dy="1268" grid="0" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="3000" pageHeight="3000" background="#ffffff" math="0" shadow="1">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="CqtvCm25UIUQusRmt474-23" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontColor=#000000;" parent="1" source="CqtvCm25UIUQusRmt474-13" target="CqtvCm25UIUQusRmt474-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-6" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryAcquire()&lt;/span&gt;&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=30;fontColor=#000000;" parent="CqtvCm25UIUQusRmt474-23" vertex="1" connectable="0">
          <mxGeometry x="0.5831" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="MHK901CGgSBkAFWm6LKR-1" value="公平锁" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#000000;" parent="CqtvCm25UIUQusRmt474-23" vertex="1" connectable="0">
          <mxGeometry x="0.2623" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-27" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryAcquire()&lt;/span&gt;&lt;/pre&gt;" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontColor=#000000;" parent="1" source="CqtvCm25UIUQusRmt474-13" target="CqtvCm25UIUQusRmt474-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="MHK901CGgSBkAFWm6LKR-2" value="非公平锁" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#000000;" parent="CqtvCm25UIUQusRmt474-27" vertex="1" connectable="0">
          <mxGeometry x="0.3266" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=30;fontColor=#000000;entryX=0.474;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" source="CqtvCm25UIUQusRmt474-13" target="CqtvCm25UIUQusRmt474-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-8" value="&lt;pre style=&quot;text-align: left ; background-color: rgb(248 , 249 , 250) ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;b&gt;acquireQueued()&lt;/b&gt;&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=30;fontColor=#000000;" parent="krwOEIBx-vB3lfnVqGeh-7" vertex="1" connectable="0">
          <mxGeometry x="0.177" y="1" relative="1" as="geometry">
            <mxPoint y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-13" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public final void &lt;/span&gt;acquire(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;arg) {//模板方法，tryAcquire()由子类负责实现&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(!tryAcquire(arg) &amp;amp;&amp;amp;&lt;br&gt;        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))&lt;font color=&quot;#cc0000&quot;&gt;//返回是否被中断&lt;/font&gt;&lt;br&gt;        selfInterrupt();&lt;br&gt;}&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fontColor=#000000;align=left;" parent="1" vertex="1">
          <mxGeometry x="667" y="450" width="778" height="133" as="geometry" />
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontColor=#000000;" parent="1" source="CqtvCm25UIUQusRmt474-14" target="CqtvCm25UIUQusRmt474-13" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="633" y="341" />
              <mxPoint x="1007" y="341" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-14" value="&lt;span style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt; font-weight: bold;&quot;&gt;final void &lt;/span&gt;&lt;span style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt; font-weight: bold; font-style: italic;&quot;&gt;lock&lt;/span&gt;&lt;span style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;() {&lt;/span&gt;&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;acquire&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;align=left;arcSize=9;labelBorderColor=none;" parent="1" vertex="1">
          <mxGeometry x="527" y="110" width="232" height="107" as="geometry" />
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-21" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontColor=#000000;" parent="1" source="CqtvCm25UIUQusRmt474-19" target="CqtvCm25UIUQusRmt474-13" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1304" y="343" />
              <mxPoint x="1007" y="343" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-19" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;lock&lt;/span&gt;&lt;span&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;compareAndSetState&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;))//立即抢锁&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;currentThread&lt;/span&gt;&lt;span&gt;())&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;else&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;        &lt;/span&gt;&lt;span&gt;acquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;//抢锁失败，&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;align=left;arcSize=8;" parent="1" vertex="1">
          <mxGeometry x="1067" y="110" width="580" height="180" as="geometry" />
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-22" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;currentThread&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span&gt;getState&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;!&lt;/span&gt;&lt;span&gt;hasQueuedPredecessors&lt;/span&gt;&lt;span&gt;() &lt;/span&gt;&lt;span&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span&gt;compareAndSetState&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    }&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;else if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;&lt;span&gt;getExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;()) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;+ &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span&gt;&amp;lt; &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;)&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;&lt;span&gt;Error&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;&quot;Maximum lock count exceeded&quot;&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;setState&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return false&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;align=left;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="40" y="735" width="777" height="425" as="geometry" />
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=30;fontColor=#000000;" parent="1" source="CqtvCm25UIUQusRmt474-26" target="krwOEIBx-vB3lfnVqGeh-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-26" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span&gt;nonfairTryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;br&gt;&lt;/pre&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;strokeColor=#000000;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="1341" y="733" width="523" height="138" as="geometry" />
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-29" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;公平锁与非公平锁tryAcquire()的&lt;/span&gt;实现唯一的区别是，公平锁多了了一个!hasQueuedPredecessors()判断,&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;hasQueuedPredecessors()&lt;/span&gt;表示排队队列不为空，并且排在队头的节点不是当前线程&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;!hasQueuedPredecessors()表示排队队列为空，或者排在队头的节点是当前线程&lt;/pre&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;glass=0;labelBackgroundColor=#ffffff;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="30" y="1176" width="946" height="113" as="geometry" />
        </mxCell>
        <mxCell id="CqtvCm25UIUQusRmt474-30" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;b&gt;这个方法只有抢到锁之后才会返回,&lt;/b&gt;&lt;/pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;&lt;b&gt;该函数不会中断响应，但它会记录被阻塞期间有没有其他线程向它发送过中断信号。如果被中断，则该函数会返回true；否则，返回false。&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquireQueued&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;try &lt;/span&gt;&lt;span&gt;{&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interrupted &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;false&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;for &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;;;&lt;/span&gt;&lt;span&gt;) {//在没有阻塞的情况下，不断取获取锁&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;predecessor&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;head &lt;span&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span&gt;tryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span&gt;setHead&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;next &lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;null&lt;/span&gt;&lt;span&gt;; &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;// help GC&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;false&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interrupted&lt;/span&gt;&lt;span&gt;;//获取锁之后，返回&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;shouldParkAfterFailedAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;&lt;span&gt;) &lt;/span&gt;&lt;span&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span&gt;parkAndCheckInterrupt&lt;/span&gt;&lt;span&gt;()){&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt; &lt;/span&gt;//&lt;/span&gt;shouldParkAfterFailedAcquire&lt;span style=&quot;font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;)判断是否需要阻塞&lt;/span&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interrupted &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;true&lt;/span&gt;&lt;span&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;&lt;span&gt; &lt;/span&gt;    }&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    } &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;finally &lt;/span&gt;&lt;span&gt;{&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed&lt;/span&gt;&lt;span&gt;)&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;cancelAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-size: 12px&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;阻塞当前线程,直到被其他线程唤醒或者被中断，该函数才返回；park（）函数返回有两种情况。&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;情况1：其他线程调用了unpark（Thread t）。&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;情况2：其他线程调用了t.interrupt（）。这里要注意的是，lock（）不能响应中断，但LockSupport.park（）会响应中断。&lt;/pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;也正因为LockSupport.park（）可能被中断唤醒，acquireQueued（..）函数才写了一个for死循环；&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;唤醒之后，如果发现自己排在队列头部，就去拿锁；如果拿不到锁，则再次自己阻塞自己；&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;不断重复此过程，直到拿到锁。被唤醒之后，通过Thread.interrupted（）来判断是否被中断唤醒；&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;如果是情况1，会返回false；&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;如果是情况2，则返回true；&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;private final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;parkAndCheckInterrupt&lt;/span&gt;&lt;span&gt;() {&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-size: 12px&quot;&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;LockSupport&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;park&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;Thread&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;interrupted&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;pre&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=none;strokeColor=#000000;fillColor=#ffffff;align=left;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="564" y="1531" width="1041" height="1043" as="geometry" />
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=30;fontColor=#000000;" parent="1" source="_KA6L-gr-Qn6RJLEGgCv-1" target="CqtvCm25UIUQusRmt474-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_KA6L-gr-Qn6RJLEGgCv-1" value="公平锁" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;glass=0;labelBackgroundColor=none;fontColor=#000000;fontSize=30;" parent="1" vertex="1">
          <mxGeometry x="568" y="24" width="150" height="20" as="geometry" />
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=30;fontColor=#000000;" parent="1" source="_KA6L-gr-Qn6RJLEGgCv-2" target="CqtvCm25UIUQusRmt474-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_KA6L-gr-Qn6RJLEGgCv-2" value="&lt;span style=&quot;text-align: left; font-size: 30px;&quot;&gt;非公平锁&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;glass=0;labelBackgroundColor=none;fontColor=#000000;fontSize=30;" parent="1" vertex="1">
          <mxGeometry x="1282" y="27" width="150" height="17" as="geometry" />
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-1" value="tryLock（）实现分析" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;glass=0;labelBackgroundColor=none;fontSize=30;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="1642" y="895" width="350" height="50" as="geometry" />
        </mxCell>
        <mxCell id="krwOEIBx-vB3lfnVqGeh-4" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-size: 12.8pt ; white-space: normal ; font-weight: bold&quot;&gt;final boolean &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; white-space: normal ; font-weight: bold ; font-style: italic&quot;&gt;nonfairTryAcquire&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; white-space: normal&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; white-space: normal ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; white-space: normal ; font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; white-space: normal&quot;&gt;) {&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;currentThread&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span&gt;getState&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;compareAndSetState&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    }&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;else if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;&lt;span&gt;getExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;()) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;+ &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span&gt;&amp;lt; &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;) &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;// overflow&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;&lt;span&gt;Error&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;&quot;Maximum lock count exceeded&quot;&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;setState&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return false&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;strokeColor=#000000;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="1285" y="961" width="635" height="453" as="geometry" />
        </mxCell>
        <mxCell id="0hTYx7RgD9tuDB6i6g-k-1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.513;entryY=-0.003;entryDx=0;entryDy=0;entryPerimeter=0;fontColor=#000000;" edge="1" parent="1" source="0hTYx7RgD9tuDB6i6g-k-5" target="0hTYx7RgD9tuDB6i6g-k-7">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="0hTYx7RgD9tuDB6i6g-k-2" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;unparkSuccessor()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#000000;fontSize=14;" vertex="1" connectable="0" parent="0hTYx7RgD9tuDB6i6g-k-1">
          <mxGeometry x="-0.311" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0hTYx7RgD9tuDB6i6g-k-3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="0hTYx7RgD9tuDB6i6g-k-5" target="0hTYx7RgD9tuDB6i6g-k-6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="0hTYx7RgD9tuDB6i6g-k-4" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;tryRelease()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#000000;fontSize=14;" vertex="1" connectable="0" parent="0hTYx7RgD9tuDB6i6g-k-3">
          <mxGeometry x="0.1688" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0hTYx7RgD9tuDB6i6g-k-5" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;release&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;) {//模板方法&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(tryRelease(&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;)) {释放锁；&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;= head;&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;!= &lt;span style=&quot;font-weight: bold&quot;&gt;null &lt;/span&gt;&amp;amp;&amp;amp; &lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;.waitStatus != 0)&lt;br&gt;            unparkSuccessor(&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;);//唤醒队列中的其他线程;&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;return true&lt;/span&gt;;&lt;br&gt;    }&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;return false&lt;/span&gt;;&lt;br&gt;}&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=30;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;align=left;" vertex="1" parent="1">
          <mxGeometry x="2401" y="133" width="540" height="240" as="geometry" />
        </mxCell>
        <mxCell id="0hTYx7RgD9tuDB6i6g-k-6" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryRelease&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;releases&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span&gt;getState&lt;/span&gt;&lt;span&gt;() &lt;/span&gt;&lt;span&gt;- &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;releases&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;currentThread&lt;/span&gt;&lt;span&gt;() &lt;/span&gt;&lt;span&gt;!= &lt;/span&gt;&lt;span&gt;getExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;())&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;&lt;span&gt;IllegalMonitorStateException&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;//不是持有锁的线程释放&lt;/span&gt;直接报错&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;free &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;false&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;) {//每调用一次，state减1，直到为0，才表示锁释放成功&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;free &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;null&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-size: 16px&quot;&gt;&lt;font face=&quot;pt mono&quot; style=&quot;font-size: 16px&quot;&gt;因为是排他锁，只有已经持有锁的线程才有资格调用release（..），这意味着没有其他线程与它争抢。&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;font-size: 16px&quot;&gt;&lt;font style=&quot;font-size: 16px&quot;&gt;所以，在上面的tryRelease（..）函数中，对state值的修改，不需要CAS操作，直接减1即可；&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;font-size: 16px&quot;&gt;&lt;font style=&quot;font-size: 16px&quot; color=&quot;#4c0099&quot;&gt;注意，加锁和解锁必须成对出现&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;font-size: 16px&quot;&gt;&lt;font style=&quot;font-size: 16px&quot;&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;    &lt;/span&gt;&lt;b&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;setState&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;)&lt;/span&gt;&lt;/b&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;&lt;b&gt;;&lt;/b&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-weight: bold&quot;&gt;free&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;}&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=30;strokeColor=#000000;fillColor=#ffffff;align=left;labelBorderColor=none;arcSize=9;" vertex="1" parent="1">
          <mxGeometry x="1911" y="558" width="800" height="490" as="geometry" />
        </mxCell>
        <mxCell id="0hTYx7RgD9tuDB6i6g-k-7" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;唤醒队列中的其他线程&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;private void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;unparkSuccessor&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;) {&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * If status is negative (i.e., possibly needing signal) try&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * to clear in anticipation of signalling.  It is OK if this&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * fails or if status is changed by waiting thread.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;= &lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;.waitStatus;&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&amp;lt; 0)&lt;br&gt;        compareAndSetWaitStatus(&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;, &lt;span style=&quot;font-weight: bold&quot;&gt;ws&lt;/span&gt;, 0);&lt;br&gt;&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * Thread to unpark is held in successor, which is normally&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * just the next node.  But if cancelled or apparently null,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * traverse backwards from tail to find the actual&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * non-cancelled successor.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;= &lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;.next;&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;== &lt;span style=&quot;font-weight: bold&quot;&gt;null &lt;/span&gt;|| &lt;span style=&quot;font-weight: bold&quot;&gt;s&lt;/span&gt;.waitStatus &amp;gt; 0) {&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;= &lt;span style=&quot;font-weight: bold&quot;&gt;null&lt;/span&gt;;&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;for &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;= tail; &lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;!= &lt;span style=&quot;font-weight: bold&quot;&gt;null &lt;/span&gt;&amp;amp;&amp;amp; &lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;!= &lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;; &lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;= &lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;.prev)&lt;br&gt;            &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;.waitStatus &amp;lt;= 0)&lt;br&gt;                &lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;= &lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;;&lt;br&gt;    }&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;!= &lt;span style=&quot;font-weight: bold&quot;&gt;null&lt;/span&gt;)&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;LockSupport&lt;/span&gt;.unpark(&lt;span style=&quot;font-weight: bold&quot;&gt;s&lt;/span&gt;.thread);&lt;font color=&quot;#ff0080&quot;&gt;//唤醒下一个在等待队列里阻塞的线程&lt;br&gt;}&lt;/font&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=22;strokeColor=#000000;fillColor=#ffffff;align=left;arcSize=9;" vertex="1" parent="1">
          <mxGeometry x="2791" y="558" width="720" height="680" as="geometry" />
        </mxCell>
        <mxCell id="0hTYx7RgD9tuDB6i6g-k-8" value="&lt;span style=&quot;text-align: center ; background-color: rgb(248 , 249 , 250)&quot;&gt;&lt;font style=&quot;font-size: 16px&quot;&gt;解锁不区分公平与非公平&lt;/font&gt;&lt;/span&gt;" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.cloud_callout;labelBackgroundColor=#ffffff;fontSize=18;fontColor=#000000;align=left;" vertex="1" parent="1">
          <mxGeometry x="2941" y="63" width="220" height="90" as="geometry" />
        </mxCell>
        <mxCell id="0hTYx7RgD9tuDB6i6g-k-10" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.48;entryY=-0.004;entryDx=0;entryDy=0;entryPerimeter=0;fontSize=30;fontColor=#000000;" edge="1" parent="1" source="0hTYx7RgD9tuDB6i6g-k-9" target="0hTYx7RgD9tuDB6i6g-k-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="0hTYx7RgD9tuDB6i6g-k-9" value="释放锁" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;shadow=1;glass=1;labelBackgroundColor=#ffffff;sketch=0;fontColor=#000000;fontSize=30;" vertex="1" parent="1">
          <mxGeometry x="2593" y="13" width="133" height="24" as="geometry" />
        </mxCell>
        <mxCell id="uPMalCJJjGVY2yAxwgIe-23" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=30;fontColor=#000000;entryX=0.509;entryY=0.008;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1" source="uPMalCJJjGVY2yAxwgIe-12" target="uPMalCJJjGVY2yAxwgIe-13">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="4959.5" y="135" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uPMalCJJjGVY2yAxwgIe-12" value="中断锁" style="text;whiteSpace=wrap;html=1;fontSize=30;fontColor=#000000;" vertex="1" parent="1">
          <mxGeometry x="4907" y="18" width="106" height="43" as="geometry" />
        </mxCell>
        <mxCell id="uPMalCJJjGVY2yAxwgIe-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=30;fontColor=#000000;" edge="1" parent="1" source="uPMalCJJjGVY2yAxwgIe-13" target="uPMalCJJjGVY2yAxwgIe-19">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uPMalCJJjGVY2yAxwgIe-13" value="&lt;font style=&quot;font-size: 16px&quot;&gt;lock（）不能被中断，lockInterruptibly（）可以被中断；lock（）必须等被中断的线程获取锁之后才能响应中断&lt;br&gt;&lt;/font&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;lockInterruptibly&lt;/span&gt;&lt;span&gt;() &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;throws &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;InterruptedException &lt;/span&gt;&lt;span&gt;{&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;sync&lt;span&gt;.&lt;/span&gt;&lt;span&gt;acquireInterruptibly&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;br&gt;&lt;/pre&gt;&lt;br&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=22;strokeColor=#000000;fillColor=#ffffff;align=left;" vertex="1" parent="1">
          <mxGeometry x="4588" y="143" width="730" height="240" as="geometry" />
        </mxCell>
        <mxCell id="uPMalCJJjGVY2yAxwgIe-14" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#000000;exitX=0;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="uPMalCJJjGVY2yAxwgIe-19" target="uPMalCJJjGVY2yAxwgIe-21">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="4398" y="562" />
              <mxPoint x="4398" y="392" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uPMalCJJjGVY2yAxwgIe-15" value="公平" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=14;fontColor=#000000;" vertex="1" connectable="0" parent="uPMalCJJjGVY2yAxwgIe-14">
          <mxGeometry x="0.3526" y="2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uPMalCJJjGVY2yAxwgIe-16" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#000000;" edge="1" parent="1" source="uPMalCJJjGVY2yAxwgIe-19" target="uPMalCJJjGVY2yAxwgIe-22">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="4398" y="562" />
              <mxPoint x="4398" y="912" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uPMalCJJjGVY2yAxwgIe-17" value="非公平" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=14;fontColor=#000000;" vertex="1" connectable="0" parent="uPMalCJJjGVY2yAxwgIe-16">
          <mxGeometry x="-0.0879" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uPMalCJJjGVY2yAxwgIe-18" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.488;entryY=-0.004;entryDx=0;entryDy=0;entryPerimeter=0;fontSize=14;fontColor=#000000;" edge="1" parent="1" source="uPMalCJJjGVY2yAxwgIe-19" target="uPMalCJJjGVY2yAxwgIe-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uPMalCJJjGVY2yAxwgIe-19" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public final void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquireInterruptibly&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;) &lt;span style=&quot;font-weight: bold&quot;&gt;throws &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;InterruptedException &lt;/span&gt;{&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;.interrupted())&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;InterruptedException();//如果当前线程被中断了，直接抛中断异常&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(!tryAcquire(&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;))//这里的tryAcquire()和lock()里的实现一样，分为公平实现和非公平实现&lt;br&gt;        doAcquireInterruptibly(&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;);&lt;br&gt;}&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=22;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;align=left;" vertex="1" parent="1">
          <mxGeometry x="4523" y="461" width="860" height="200" as="geometry" />
        </mxCell>
        <mxCell id="uPMalCJJjGVY2yAxwgIe-20" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-size: 12.8pt ; font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#ea6b66&quot;&gt;//和acquireQueued()实现一样，唯一的区别是返回布尔值还是抛异常&lt;/font&gt;&lt;/b&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold&quot;&gt;private void &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold ; font-style: italic&quot;&gt;doAcquireInterruptibly&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold&quot;&gt;throws &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold&quot;&gt;InterruptedException &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;{&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span&gt;addWaiter&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;EXCLUSIVE)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;try &lt;/span&gt;&lt;span&gt;{&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;for &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;;;&lt;/span&gt;&lt;span&gt;) {//&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;predecessor&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;head &lt;span&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span&gt;tryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span&gt;setHead&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;next &lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;null&lt;/span&gt;&lt;span&gt;; &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;// help GC&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;false&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;shouldParkAfterFailedAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;) &lt;/span&gt;&lt;span&gt;&amp;amp;&amp;amp;&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span&gt;parkAndCheckInterrupt&lt;/span&gt;&lt;span&gt;())&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;&lt;span&gt;InterruptedException&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    } &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;finally &lt;/span&gt;&lt;span&gt;{&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed&lt;/span&gt;&lt;span&gt;)&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;cancelAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=none;fontSize=22;strokeColor=#000000;fillColor=#ffffff;align=left;arcSize=9;" vertex="1" parent="1">
          <mxGeometry x="4562" y="762" width="800" height="570" as="geometry" />
        </mxCell>
        <mxCell id="uPMalCJJjGVY2yAxwgIe-21" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;tryAcquire&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Thread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;currentThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;!&lt;/span&gt;&lt;span style=&quot;&quot;&gt;hasQueuedPredecessors&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;+ &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;lt; &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;throw new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;Error&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&quot;Maximum lock count exceeded&quot;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=14;align=left;arcSize=6;" vertex="1" parent="1">
          <mxGeometry x="3608" y="152" width="610" height="450" as="geometry" />
        </mxCell>
        <mxCell id="uPMalCJJjGVY2yAxwgIe-22" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span&gt;nonfairTryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;nonfairTryAcquire&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Thread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;currentThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;+ &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;lt; &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// overflow&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;throw new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;Error&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&quot;Maximum lock count exceeded&quot;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=14;align=left;arcSize=7;" vertex="1" parent="1">
          <mxGeometry x="3608" y="642" width="610" height="520" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="szI1ShmyNPP52Lu-LX1a" name="(互斥锁)释放锁">
    <mxGraphModel dx="2514" dy="1268" grid="0" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="2000" pageHeight="2000" math="0" shadow="0">
      <root>
        <mxCell id="kUkIeRc0tFKLB3FnhXx1-0" />
        <mxCell id="kUkIeRc0tFKLB3FnhXx1-1" parent="kUkIeRc0tFKLB3FnhXx1-0" />
        <mxCell id="gaisI5OQv5GdU1nkk_C--0" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.513;entryY=-0.003;entryDx=0;entryDy=0;entryPerimeter=0;fontColor=#000000;" parent="kUkIeRc0tFKLB3FnhXx1-1" source="hQ5Be9MLbmskBuh1OfqU-1" target="hQ5Be9MLbmskBuh1OfqU-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="gaisI5OQv5GdU1nkk_C--4" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;unparkSuccessor()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#000000;fontSize=14;" parent="gaisI5OQv5GdU1nkk_C--0" vertex="1" connectable="0">
          <mxGeometry x="-0.311" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gaisI5OQv5GdU1nkk_C--1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontColor=#000000;" parent="kUkIeRc0tFKLB3FnhXx1-1" source="hQ5Be9MLbmskBuh1OfqU-1" target="hQ5Be9MLbmskBuh1OfqU-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="gaisI5OQv5GdU1nkk_C--3" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;tryRelease()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#000000;fontSize=14;" parent="gaisI5OQv5GdU1nkk_C--1" vertex="1" connectable="0">
          <mxGeometry x="0.1688" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="hQ5Be9MLbmskBuh1OfqU-1" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;release&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;) {//模板方法&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(tryRelease(&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;)) {释放锁；&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;= head;&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;!= &lt;span style=&quot;font-weight: bold&quot;&gt;null &lt;/span&gt;&amp;amp;&amp;amp; &lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;.waitStatus != 0)&lt;br&gt;            unparkSuccessor(&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;);//唤醒队列中的其他线程;&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;return true&lt;/span&gt;;&lt;br&gt;    }&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;return false&lt;/span&gt;;&lt;br&gt;}&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=30;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;align=left;" parent="kUkIeRc0tFKLB3FnhXx1-1" vertex="1">
          <mxGeometry x="690" y="260" width="540" height="240" as="geometry" />
        </mxCell>
        <mxCell id="hQ5Be9MLbmskBuh1OfqU-2" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryRelease&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;releases&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span&gt;getState&lt;/span&gt;&lt;span&gt;() &lt;/span&gt;&lt;span&gt;- &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;releases&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;currentThread&lt;/span&gt;&lt;span&gt;() &lt;/span&gt;&lt;span&gt;!= &lt;/span&gt;&lt;span&gt;getExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;())&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;&lt;span&gt;IllegalMonitorStateException&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;//不是持有锁的线程释放&lt;/span&gt;直接报错&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;free &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;false&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;) {//每调用一次，state减1，直到为0，才表示锁释放成功&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;free &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;null&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-size: 16px&quot;&gt;&lt;font face=&quot;pt mono&quot; style=&quot;font-size: 16px&quot;&gt;因为是排他锁，只有已经持有锁的线程才有资格调用release（..），这意味着没有其他线程与它争抢。&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;font-size: 16px&quot;&gt;&lt;font style=&quot;font-size: 16px&quot;&gt;所以，在上面的tryRelease（..）函数中，对state值的修改，不需要CAS操作，直接减1即可；&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;font-size: 16px&quot;&gt;&lt;font style=&quot;font-size: 16px&quot; color=&quot;#4c0099&quot;&gt;注意，加锁和解锁必须成对出现&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;font-size: 16px&quot;&gt;&lt;font style=&quot;font-size: 16px&quot;&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;    &lt;/span&gt;&lt;b&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;setState&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;)&lt;/span&gt;&lt;/b&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;&lt;b&gt;;&lt;/b&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-weight: bold&quot;&gt;free&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;}&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=30;strokeColor=#000000;fillColor=#ffffff;align=left;labelBorderColor=none;arcSize=9;" parent="kUkIeRc0tFKLB3FnhXx1-1" vertex="1">
          <mxGeometry x="200" y="685" width="800" height="490" as="geometry" />
        </mxCell>
        <mxCell id="hQ5Be9MLbmskBuh1OfqU-10" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;唤醒队列中的其他线程&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;private void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;unparkSuccessor&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;) {&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * If status is negative (i.e., possibly needing signal) try&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * to clear in anticipation of signalling.  It is OK if this&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * fails or if status is changed by waiting thread.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;= &lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;.waitStatus;&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&amp;lt; 0)&lt;br&gt;        compareAndSetWaitStatus(&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;, &lt;span style=&quot;font-weight: bold&quot;&gt;ws&lt;/span&gt;, 0);&lt;br&gt;&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * Thread to unpark is held in successor, which is normally&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * just the next node.  But if cancelled or apparently null,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * traverse backwards from tail to find the actual&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * non-cancelled successor.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;= &lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;.next;&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;== &lt;span style=&quot;font-weight: bold&quot;&gt;null &lt;/span&gt;|| &lt;span style=&quot;font-weight: bold&quot;&gt;s&lt;/span&gt;.waitStatus &amp;gt; 0) {&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;= &lt;span style=&quot;font-weight: bold&quot;&gt;null&lt;/span&gt;;&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;for &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;= tail; &lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;!= &lt;span style=&quot;font-weight: bold&quot;&gt;null &lt;/span&gt;&amp;amp;&amp;amp; &lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;!= &lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;node&lt;/span&gt;; &lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;= &lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;.prev)&lt;br&gt;            &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;.waitStatus &amp;lt;= 0)&lt;br&gt;                &lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;= &lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;;&lt;br&gt;    }&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;!= &lt;span style=&quot;font-weight: bold&quot;&gt;null&lt;/span&gt;)&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;LockSupport&lt;/span&gt;.unpark(&lt;span style=&quot;font-weight: bold&quot;&gt;s&lt;/span&gt;.thread);&lt;font color=&quot;#ff0080&quot;&gt;//唤醒下一个在等待队列里阻塞的线程&lt;br&gt;}&lt;/font&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=22;strokeColor=#000000;fillColor=#ffffff;align=left;arcSize=9;" parent="kUkIeRc0tFKLB3FnhXx1-1" vertex="1">
          <mxGeometry x="1080" y="685" width="720" height="680" as="geometry" />
        </mxCell>
        <mxCell id="SMU3NQiLPeNhD6TF8_aj-0" value="&lt;span style=&quot;text-align: center ; background-color: rgb(248 , 249 , 250)&quot;&gt;&lt;font style=&quot;font-size: 16px&quot;&gt;解锁不区分公平与非公平&lt;/font&gt;&lt;/span&gt;" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.cloud_callout;labelBackgroundColor=#ffffff;fontSize=18;fontColor=#000000;align=left;" parent="kUkIeRc0tFKLB3FnhXx1-1" vertex="1">
          <mxGeometry x="1230" y="190" width="220" height="90" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="JNv3_J8_Sh6OVfC3o5AA" name="(互斥锁)中断锁">
    <mxGraphModel dx="2514" dy="1268" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="2000" pageHeight="2000" math="0" shadow="0">
      <root>
        <mxCell id="GkP1prsd0XOYrcYADEeq-0" />
        <mxCell id="GkP1prsd0XOYrcYADEeq-1" parent="GkP1prsd0XOYrcYADEeq-0" />
        <mxCell id="SpEC_mB6sUZVsmlTsD8X-0" value="lockInterruptibly（）实现分析" style="text;whiteSpace=wrap;html=1;fontSize=22;fontColor=#000000;" parent="GkP1prsd0XOYrcYADEeq-1" vertex="1">
          <mxGeometry x="1180" y="60" width="310" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SpEC_mB6sUZVsmlTsD8X-2" value="&lt;font style=&quot;font-size: 16px&quot;&gt;lock（）不能被中断，lockInterruptibly（）可以被中断；lock（）必须等被中断的线程获取锁之后才能响应中断&lt;br&gt;&lt;/font&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;lockInterruptibly&lt;/span&gt;&lt;span&gt;() &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;throws &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;InterruptedException &lt;/span&gt;&lt;span&gt;{&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;sync&lt;span&gt;.&lt;/span&gt;&lt;span&gt;acquireInterruptibly&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;br&gt;&lt;/pre&gt;&lt;br&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=22;strokeColor=#000000;fillColor=#ffffff;align=left;" parent="GkP1prsd0XOYrcYADEeq-1" vertex="1">
          <mxGeometry x="990" y="110" width="730" height="240" as="geometry" />
        </mxCell>
        <mxCell id="5fQTfYabW9B-tewhtZIN-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#000000;exitX=0;exitY=0.5;exitDx=0;exitDy=0;" parent="GkP1prsd0XOYrcYADEeq-1" source="B13aK4WdRRfeDaFlvRMU-0" target="5fQTfYabW9B-tewhtZIN-0" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="800" y="530" />
              <mxPoint x="800" y="360" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="5fQTfYabW9B-tewhtZIN-4" value="公平" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=14;fontColor=#000000;" parent="5fQTfYabW9B-tewhtZIN-2" vertex="1" connectable="0">
          <mxGeometry x="0.3526" y="2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="5fQTfYabW9B-tewhtZIN-7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#000000;" parent="GkP1prsd0XOYrcYADEeq-1" source="B13aK4WdRRfeDaFlvRMU-0" target="5fQTfYabW9B-tewhtZIN-5" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="800" y="530" />
              <mxPoint x="800" y="880" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="5fQTfYabW9B-tewhtZIN-8" value="非公平" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=14;fontColor=#000000;" parent="5fQTfYabW9B-tewhtZIN-7" vertex="1" connectable="0">
          <mxGeometry x="-0.0879" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="5fQTfYabW9B-tewhtZIN-9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.488;entryY=-0.004;entryDx=0;entryDy=0;entryPerimeter=0;fontSize=14;fontColor=#000000;" parent="GkP1prsd0XOYrcYADEeq-1" source="B13aK4WdRRfeDaFlvRMU-0" target="B13aK4WdRRfeDaFlvRMU-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="B13aK4WdRRfeDaFlvRMU-0" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public final void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquireInterruptibly&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;) &lt;span style=&quot;font-weight: bold&quot;&gt;throws &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;InterruptedException &lt;/span&gt;{&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;.interrupted())&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;InterruptedException();//如果当前线程被中断了，直接抛中断异常&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(!tryAcquire(&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;))//这里的tryAcquire()和lock()里的实现一样，分为公平实现和非公平实现&lt;br&gt;        doAcquireInterruptibly(&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;);&lt;br&gt;}&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=22;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;align=left;" parent="GkP1prsd0XOYrcYADEeq-1" vertex="1">
          <mxGeometry x="960" y="430" width="860" height="200" as="geometry" />
        </mxCell>
        <mxCell id="B13aK4WdRRfeDaFlvRMU-1" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-size: 12.8pt ; font-family: &amp;#34;pt mono&amp;#34;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#ea6b66&quot;&gt;//和acquireQueued()实现一样，唯一的区别是返回布尔值还是抛异常&lt;/font&gt;&lt;/b&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold&quot;&gt;private void &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold ; font-style: italic&quot;&gt;doAcquireInterruptibly&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold&quot;&gt;throws &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; font-weight: bold&quot;&gt;InterruptedException &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;{&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span&gt;addWaiter&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;EXCLUSIVE)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;try &lt;/span&gt;&lt;span&gt;{&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;for &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;;;&lt;/span&gt;&lt;span&gt;) {//&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;predecessor&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p &lt;/span&gt;&lt;span&gt;== &lt;/span&gt;head &lt;span&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span&gt;tryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span&gt;setHead&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;next &lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;null&lt;/span&gt;&lt;span&gt;; &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;// help GC&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;false&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;shouldParkAfterFailedAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;) &lt;/span&gt;&lt;span&gt;&amp;amp;&amp;amp;&lt;br&gt;&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;span&gt;parkAndCheckInterrupt&lt;/span&gt;&lt;span&gt;())&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;&lt;span&gt;InterruptedException&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    } &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;finally &lt;/span&gt;&lt;span&gt;{&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed&lt;/span&gt;&lt;span&gt;)&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;cancelAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=none;fontSize=22;strokeColor=#000000;fillColor=#ffffff;align=left;arcSize=9;" parent="GkP1prsd0XOYrcYADEeq-1" vertex="1">
          <mxGeometry x="1000" y="750" width="800" height="570" as="geometry" />
        </mxCell>
        <mxCell id="5fQTfYabW9B-tewhtZIN-0" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;tryAcquire&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Thread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;currentThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;!&lt;/span&gt;&lt;span style=&quot;&quot;&gt;hasQueuedPredecessors&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;+ &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;lt; &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;throw new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;Error&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&quot;Maximum lock count exceeded&quot;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=14;align=left;arcSize=6;" parent="GkP1prsd0XOYrcYADEeq-1" vertex="1">
          <mxGeometry x="10" y="120" width="610" height="450" as="geometry" />
        </mxCell>
        <mxCell id="5fQTfYabW9B-tewhtZIN-5" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span&gt;nonfairTryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;nonfairTryAcquire&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Thread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;currentThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;+ &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;acquires&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;lt; &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// overflow&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;throw new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;Error&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&quot;Maximum lock count exceeded&quot;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=14;align=left;arcSize=7;" parent="GkP1prsd0XOYrcYADEeq-1" vertex="1">
          <mxGeometry x="10" y="610" width="610" height="520" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="m-LhpGy6pDTVkrjs-Amt" name="读写锁">
    <mxGraphModel dx="2514" dy="1268" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="3000" pageHeight="1000" math="0" shadow="0">
      <root>
        <mxCell id="4Kn29drxNQvWNtrvnITc-0" />
        <mxCell id="4Kn29drxNQvWNtrvnITc-1" parent="4Kn29drxNQvWNtrvnITc-0" />
        <mxCell id="KTipewaxF2whKSaPG7UM-0" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" parent="4Kn29drxNQvWNtrvnITc-1" source="4Kn29drxNQvWNtrvnITc-2" target="lFT8Ks_veNPhik5HumSQ-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4Kn29drxNQvWNtrvnITc-2" value="读写锁实现" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;glass=0;labelBackgroundColor=none;fontSize=30;fontColor=#000000;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="1745.83" y="40" width="190" height="40" as="geometry" />
        </mxCell>
        <mxCell id="VO5wA90HG24xElYhcVth-9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.998;entryY=0.541;entryDx=0;entryDy=0;entryPerimeter=0;" parent="4Kn29drxNQvWNtrvnITc-1" source="C6gt7NBxkSrmRmRFl4JR-8" target="C6gt7NBxkSrmRmRFl4JR-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="VO5wA90HG24xElYhcVth-10" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="4Kn29drxNQvWNtrvnITc-1" source="C6gt7NBxkSrmRmRFl4JR-8" target="C6gt7NBxkSrmRmRFl4JR-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="C6gt7NBxkSrmRmRFl4JR-8" value="共用&lt;br&gt;Sync" style="html=1;whiteSpace=wrap;aspect=fixed;shape=isoRectangle;rounded=0;glass=0;labelBackgroundColor=#ffffff;fontSize=16;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;align=center;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="2125" y="626" width="115.01" height="69" as="geometry" />
        </mxCell>
        <mxCell id="2I2go7Ke-rsbTxs8lcRy-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#000000;" parent="4Kn29drxNQvWNtrvnITc-1" source="C6gt7NBxkSrmRmRFl4JR-12" target="Z4jG9dqAK4cvpMTp8F6e-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="C6gt7NBxkSrmRmRFl4JR-12" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;lock&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;sync&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;acquireShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;glass=0;labelBackgroundColor=#ffffff;fontSize=16;strokeColor=#000000;fillColor=#ffffff;align=left;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="577" y="1701" width="303" height="124" as="geometry" />
        </mxCell>
        <mxCell id="2I2go7Ke-rsbTxs8lcRy-0" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#000000;" parent="4Kn29drxNQvWNtrvnITc-1" source="C6gt7NBxkSrmRmRFl4JR-13" target="C6gt7NBxkSrmRmRFl4JR-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="C6gt7NBxkSrmRmRFl4JR-13" value="&lt;p style=&quot;margin: 0px ; margin-top: 4px ; text-align: center&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;Class&amp;gt;&amp;gt;&lt;/i&gt;&lt;br&gt;&lt;b&gt;ReadLock&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;+&amp;nbsp;&amp;nbsp;sync: Sync extends AQS&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ void lock();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ void lockInterruptibly() throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ boolean tryLock();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ boolean tryLock(long time, TimeUnit unit) throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;span style=&quot;font-size: x-small&quot;&gt;+ void unlock();&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;rounded=0;glass=0;labelBackgroundColor=#ffffff;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="1224.5" y="569" width="450" height="170" as="geometry" />
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=16;fontColor=#000000;" parent="4Kn29drxNQvWNtrvnITc-1" source="C6gt7NBxkSrmRmRFl4JR-14" target="2I2go7Ke-rsbTxs8lcRy-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="C6gt7NBxkSrmRmRFl4JR-14" value="&lt;p style=&quot;margin: 0px ; margin-top: 4px ; text-align: center&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;Interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br&gt;&lt;b&gt;WriteLock&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;+&amp;nbsp;&amp;nbsp;sync: Sync extends AQS&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ void lock();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ void lockInterruptibly() throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ boolean tryLock();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ boolean tryLock(long time, TimeUnit unit) throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;span style=&quot;font-size: x-small&quot;&gt;+ void unlock();&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;rounded=0;glass=0;labelBackgroundColor=#ffffff;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="2538" y="576" width="450" height="170" as="geometry" />
        </mxCell>
        <mxCell id="VO5wA90HG24xElYhcVth-1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="4Kn29drxNQvWNtrvnITc-1" source="lFT8Ks_veNPhik5HumSQ-1" target="C6gt7NBxkSrmRmRFl4JR-13" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1840.5" y="432" />
              <mxPoint x="1449.5" y="432" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="VO5wA90HG24xElYhcVth-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.531;entryY=-0.024;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="4Kn29drxNQvWNtrvnITc-1" source="lFT8Ks_veNPhik5HumSQ-1" target="C6gt7NBxkSrmRmRFl4JR-14" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1841" y="445" />
              <mxPoint x="2777" y="445" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="lFT8Ks_veNPhik5HumSQ-1" value="&lt;p style=&quot;margin: 0px ; margin-top: 4px ; text-align: center&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;Interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br&gt;&lt;b&gt;Lock&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;+&amp;nbsp;&amp;nbsp;sync: Sync extends AQS&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ void lock();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ void lockInterruptibly() throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ boolean tryLock();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;+ boolean tryLock(long time, TimeUnit unit) throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;span style=&quot;font-size: x-small&quot;&gt;+ void unlock();&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;rounded=0;glass=0;labelBackgroundColor=#ffffff;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="1615.83" y="215" width="450" height="170" as="geometry" />
        </mxCell>
        <mxCell id="VO5wA90HG24xElYhcVth-0" value="&lt;p style=&quot;margin: 0px ; margin-top: 4px ; text-align: center&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;Interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br&gt;&lt;b&gt;ReentrantReadWriteLock&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;+ readerLock: ReadLock&amp;nbsp;implement Lock&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;+ writerLock: WriteLock implement Lock&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;+ readLock(): ReadLock&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;+ writeLock(): WriteLock&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;rounded=0;glass=0;labelBackgroundColor=#ffffff;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="1747.5" y="476" width="290" height="160" as="geometry" />
        </mxCell>
        <mxCell id="Z4jG9dqAK4cvpMTp8F6e-5" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;static final class &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;FairSync &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;extends &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Sync &lt;/span&gt;&lt;span&gt;{&lt;/span&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;writerShouldBlock&lt;/span&gt;&lt;span&gt;() {//写线程是否应该阻塞&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span&gt;hasQueuedPredecessors&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;//如果排队队列不为空，&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;&lt;span&gt; &lt;/span&gt;并且排在队头的节点线程不是当前准备抢锁的写线程，那么需要阻塞&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;readerShouldBlock&lt;/span&gt;&lt;span&gt;() {&lt;/span&gt;//读线程是否应该阻塞&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span&gt;hasQueuedPredecessors&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;/span&gt;//如果排队队列不为空，&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt; 并且排在队头的节点线程不是当前准备抢锁的读线程，那么需要阻塞&lt;/pre&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;align=left;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="2159" y="1479" width="621" height="401" as="geometry" />
        </mxCell>
        <mxCell id="2I2go7Ke-rsbTxs8lcRy-3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#000000;" parent="4Kn29drxNQvWNtrvnITc-1" source="Z4jG9dqAK4cvpMTp8F6e-6" target="Z4jG9dqAK4cvpMTp8F6e-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-1" value="&lt;pre style=&quot;color: rgb(0 , 0 , 0) ; text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;tryAcquireShared()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=16;fontColor=#FF0000;" parent="2I2go7Ke-rsbTxs8lcRy-3" vertex="1" connectable="0">
          <mxGeometry x="-0.2825" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2I2go7Ke-rsbTxs8lcRy-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#000000;" parent="4Kn29drxNQvWNtrvnITc-1" source="Z4jG9dqAK4cvpMTp8F6e-6" target="2I2go7Ke-rsbTxs8lcRy-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-2" value="&lt;pre style=&quot;color: rgb(0 , 0 , 0) ; text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;doAcquireShared()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=16;fontColor=#FF0000;" parent="2I2go7Ke-rsbTxs8lcRy-4" vertex="1" connectable="0">
          <mxGeometry x="0.5116" y="-3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Z4jG9dqAK4cvpMTp8F6e-6" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;共享锁,模板方法&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;Semaphore，CountDownLatch,ReentrantReadWriteLock&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;均有实现&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public final void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquireShared&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;tryAcquireShared&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;) &lt;/span&gt;&lt;span&gt;&amp;lt; &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;)&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;doAcquireShared&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;align=left;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="483" y="1880" width="516" height="260" as="geometry" />
        </mxCell>
        <mxCell id="VkflFZi93BrO_o7EnHx4-1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=16;fontColor=#000000;" parent="4Kn29drxNQvWNtrvnITc-1" source="Z4jG9dqAK4cvpMTp8F6e-7" target="VkflFZi93BrO_o7EnHx4-0" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Z4jG9dqAK4cvpMTp8F6e-7" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;protected final int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryAcquireShared&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;unused&lt;/span&gt;) {&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * Walkthrough:&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * 1. If write lock held by another thread, fail.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * 2. Otherwise, this thread is eligible for&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    lock wrt state, so ask if it should block&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    because of queue policy. If not, try&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    to grant by CASing state and updating count.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    Note that step does not check for reentrant&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    acquires, which is postponed to full version&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    to avoid having to check hold count in&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    the more typical non-reentrant case.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * 3. If step 2 fails either because thread&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    apparently not eligible or CAS fails or count&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    saturated, chain to version with full retry loop.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;= &lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;.currentThread();&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;= getState();&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(exclusiveCount(&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;) != 0 &amp;amp;&amp;amp;&lt;br&gt;        getExclusiveOwnerThread() != &lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;)&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;-1;&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;r &lt;/span&gt;= sharedCount(&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;);&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;font color=&quot;#cc0000&quot;&gt;!&lt;span style=&quot;font-weight: bold&quot;&gt;readerShouldBlock&lt;/span&gt;()&lt;/font&gt; &amp;amp;&amp;amp;//公平与非公平实现的差异在这里&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;r &lt;/span&gt;&amp;lt; MAX_COUNT &amp;amp;&amp;amp;&lt;br&gt;        compareAndSetState(&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;, &lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;+ SHARED_UNIT)) {//CAS拿读锁，&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        高16位加1&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;r &lt;/span&gt;== 0) {//r在CAS之前等于0表示，当前是第一个获取读锁的线程&lt;br&gt;            firstReader = &lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;;&lt;br&gt;            firstReaderHoldCount = 1;&lt;br&gt;        } &lt;span style=&quot;font-weight: bold&quot;&gt;else if &lt;/span&gt;(firstReader == &lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;) {//不是第一个获取读锁的线程&lt;br&gt;            firstReaderHoldCount++;&lt;br&gt;        } &lt;span style=&quot;font-weight: bold&quot;&gt;else &lt;/span&gt;{&lt;br&gt;            &lt;span style=&quot;font-weight: bold&quot;&gt;HoldCounter &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;= cachedHoldCounter;&lt;br&gt;            &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;== &lt;span style=&quot;font-weight: bold&quot;&gt;null &lt;/span&gt;|| &lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;.tid != getThreadId(&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;))&lt;br&gt;                cachedHoldCounter = &lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;= readHolds.get();&lt;br&gt;            &lt;span style=&quot;font-weight: bold&quot;&gt;else if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;.count == 0)&lt;br&gt;                readHolds.set(&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;);&lt;br&gt;            &lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;.count++;&lt;br&gt;        }&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;1;&lt;br&gt;    }&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;fullTryAcquireShared(&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;);&lt;font color=&quot;#cc0000&quot;&gt;//上面拿锁失败，进入这个方法&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;font color=&quot;#cc0000&quot;&gt;不断自旋拿读锁&lt;/font&gt;&lt;br&gt;}&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;align=left;arcSize=9;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="59" y="2282" width="697" height="990" as="geometry" />
        </mxCell>
        <mxCell id="TUMVNPgcMENQiV9ykWhL-6" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot; ; font-size: 12.8pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;static final class &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;NonfairSync &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;extends &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Sync &lt;/span&gt;{&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;writerShouldBlock&lt;/span&gt;() {&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;return false&lt;/span&gt;;&lt;span style=&quot;font-style: italic&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;}&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;readerShouldBlock&lt;/span&gt;() {&lt;span style=&quot;font-style: italic&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;apparentlyFirstQueuedIsExclusive();&lt;br&gt;    }&lt;br&gt;}&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;align=left;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="1592" y="1503" width="525" height="244" as="geometry" />
        </mxCell>
        <mxCell id="2I2go7Ke-rsbTxs8lcRy-1" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;private void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;doAcquireShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;addWaiter&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;SHARED)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;try &lt;/span&gt;&lt;span style=&quot;&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interrupted &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;for &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;predecessor&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;head&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;r &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;tryAcquireShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;r &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setHeadAndPropagate&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;r&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;next &lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;; &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// help GC&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interrupted&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;selfInterrupt&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;shouldParkAfterFailedAcquire&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;&quot;&gt;parkAndCheckInterrupt&lt;/span&gt;&lt;span style=&quot;&quot;&gt;())&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interrupted &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    } &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;finally &lt;/span&gt;&lt;span style=&quot;&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;failed&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;cancelAcquire&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=14;align=left;arcSize=9;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="1029" y="2301" width="725" height="888" as="geometry" />
        </mxCell>
        <mxCell id="KTipewaxF2whKSaPG7UM-1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" parent="4Kn29drxNQvWNtrvnITc-1" source="2I2go7Ke-rsbTxs8lcRy-5" target="2I2go7Ke-rsbTxs8lcRy-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2I2go7Ke-rsbTxs8lcRy-5" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;lock&lt;/span&gt;&lt;span&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;sync&lt;span&gt;.&lt;/span&gt;&lt;span&gt;acquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;//走互斥锁流程&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=14;align=left;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="2988" y="968" width="355" height="107" as="geometry" />
        </mxCell>
        <mxCell id="rJTA5NB_A3fbP47ulosW-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=14;fontColor=#000000;" parent="4Kn29drxNQvWNtrvnITc-1" source="2I2go7Ke-rsbTxs8lcRy-6" target="rJTA5NB_A3fbP47ulosW-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2I2go7Ke-rsbTxs8lcRy-6" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;b&gt;写锁是互斥锁，和互斥锁的流程一样，都是基于AQS的模板方法，&lt;/b&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;b&gt;区别在tryAcquire()&lt;/b&gt;&lt;b style=&quot;font-size: 12.8pt ; white-space: normal&quot;&gt;方法的实现上&lt;/b&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public final void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;!&lt;/span&gt;&lt;span&gt;tryAcquire&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;) &lt;/span&gt;&lt;span&gt;&amp;amp;&amp;amp;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;acquireQueued&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;addWaiter&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;EXCLUSIVE)&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;arg&lt;/span&gt;&lt;span&gt;))&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;selfInterrupt&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=14;align=left;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="2870" y="1181" width="591" height="251" as="geometry" />
        </mxCell>
        <mxCell id="rJTA5NB_A3fbP47ulosW-1" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;tryAcquire&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;) {&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * Walkthrough:&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * 1. If read count nonzero or write count nonzero&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    and owner is a different thread, fail.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * 2. If count would saturate, fail. (This can only&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    happen if count is already nonzero.)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     * 3. Otherwise, this thread is eligible for lock if&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    it is either a reentrant acquire or&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    queue policy allows it. If so, update state&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     *    and set owner.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;= &lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;.currentThread();&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;= getState();&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;w &lt;/span&gt;= exclusiveCount(&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;);//表示&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;!= 0) {//有线程持有锁（读锁或者写锁）&lt;br&gt;        &lt;span style=&quot;font-style: italic&quot;&gt;// (Note: if c != 0 and w == 0 then shared count != 0)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;w &lt;/span&gt;== 0 || &lt;span style=&quot;font-weight: bold&quot;&gt;current &lt;/span&gt;!= getExclusiveOwnerThread())&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;white-space: pre&quot;&gt; &lt;/span&gt;//w=0表示读线程占有锁，w!=0表示写线程占有锁，如果是写线程占有锁，&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;得看看是不是当前线程&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;span style=&quot;font-weight: bold&quot;&gt;return false&lt;/span&gt;;&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;w &lt;/span&gt;+ exclusiveCount(&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;) &amp;gt; MAX_COUNT)&lt;br&gt;            &lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;Error(&quot;Maximum lock count exceeded&quot;);&lt;br&gt;        &lt;span style=&quot;font-style: italic&quot;&gt;// Reentrant acquire&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;        &lt;/span&gt;setState(&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;+ &lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;);&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;return true&lt;/span&gt;;&lt;br&gt;    }&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;//能走到这里，表示c=0,没有线程持有锁&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;font color=&quot;#ff0000&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;writerShouldBlock&lt;/span&gt;()&lt;/font&gt; ||&lt;br&gt;        !compareAndSetState(&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;, &lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;+ &lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;acquires&lt;/span&gt;))&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;return false&lt;/span&gt;;&lt;br&gt;    setExclusiveOwnerThread(&lt;span style=&quot;font-weight: bold&quot;&gt;current&lt;/span&gt;);&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;return true&lt;/span&gt;;&lt;br&gt;}&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=14;align=left;arcSize=8;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="2823.5" y="1547" width="684" height="893" as="geometry" />
        </mxCell>
        <mxCell id="LARzN_jPg7y_6yzF4rrd-0" value="&lt;span style=&quot;font-size: 16px;&quot;&gt;读写锁和互斥锁的内部都定义了一个Sync内部类，继承AQS&lt;/span&gt;" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.cloud_callout;labelBackgroundColor=#ffffff;fontSize=16;align=left;fontColor=#FF3333;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="2209" y="513" width="230" height="122" as="geometry" />
        </mxCell>
        <mxCell id="LARzN_jPg7y_6yzF4rrd-2" value="&lt;font style=&quot;font-size: 16px&quot;&gt;注意：&lt;br&gt;互斥锁的tryAcquire()分公平和非公平实现，读写锁的tryAcquire()不区分&lt;/font&gt;" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.cloud_callout;labelBackgroundColor=#ffffff;fontSize=14;align=left;fontColor=#FF3333;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="3456" y="1042" width="305" height="161" as="geometry" />
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-0" value="注意：&lt;br&gt;读写锁的&lt;span style=&quot;font-family: &amp;quot;pt mono&amp;quot; ; font-size: 12.8pt&quot;&gt;tryAcquireShared()方法&lt;br&gt;不区分公平和非公平实现&lt;/span&gt;" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.cloud_callout;labelBackgroundColor=#ffffff;fontSize=16;align=left;fontColor=#FF0000;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="997" y="1692" width="299" height="220" as="geometry" />
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-4" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;ReadLock和WriteLock共用一个Sync对象，ReentrantReadWriteLock内部&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;维护一个Sync对象，ReentrantLock内部也维护一个Sync对象，均继承AQS&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ReentrantReadWriteLock&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;fair&lt;/span&gt;) {&lt;br&gt;    sync = &lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;fair &lt;/span&gt;? &lt;span style=&quot;font-weight: bold&quot;&gt;new &lt;/span&gt;FairSync() : &lt;span style=&quot;font-weight: bold&quot;&gt;new &lt;/span&gt;NonfairSync();&lt;br&gt;    readerLock = &lt;span style=&quot;font-weight: bold&quot;&gt;new &lt;/span&gt;ReadLock(&lt;span style=&quot;font-weight: bold&quot;&gt;this&lt;/span&gt;);&lt;br&gt;    writerLock = &lt;span style=&quot;font-weight: bold&quot;&gt;new &lt;/span&gt;WriteLock(&lt;span style=&quot;font-weight: bold&quot;&gt;this&lt;/span&gt;);&lt;br&gt;}&lt;/pre&gt;" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.rectCallout;dx=30;dy=15;boundedLbl=1;labelBackgroundColor=#ffffff;fontSize=16;fontColor=#000000;align=left;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="2142" y="122" width="648" height="276" as="geometry" />
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=16;fontColor=#000000;" parent="4Kn29drxNQvWNtrvnITc-1" source="iOsgHEEnQ7MRM6_jHvUU-5" target="TUMVNPgcMENQiV9ykWhL-6" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2144" y="1428" />
              <mxPoint x="1886" y="1428" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=16;fontColor=#000000;" parent="4Kn29drxNQvWNtrvnITc-1" source="iOsgHEEnQ7MRM6_jHvUU-5" target="Z4jG9dqAK4cvpMTp8F6e-5" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2145" y="1428" />
              <mxPoint x="2419" y="1428" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="iOsgHEEnQ7MRM6_jHvUU-5" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;&lt;br class=&quot;Apple-interchange-newline&quot;&gt;abstract static class &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Sync &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;extends &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;AbstractQueuedSynchronizer &lt;/span&gt;{&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;private static final long &lt;/span&gt;serialVersionUID = 6317671515068378041L;&lt;br&gt;&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/*&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;     *同互斥锁一样，读写锁也是用state变量来表示锁状态的。&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;     *只是state变量在这里的含义和互斥锁完全不同。&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;     *同互斥锁一样，读写锁也是用state变量来表示锁状态的。只是state变量在这里的含义和互斥锁完全不同。&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;     *在内部类Sync中，对state变量进行了重新定义，分高16位和低16位（一个int类型4个字节）,&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;     *高16位表示读锁重入次数，低16位表示写锁重入次数&lt;span style=&quot;font-style: italic&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;static final int &lt;/span&gt;SHARED_SHIFT   = 16;&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;static final int &lt;/span&gt;SHARED_UNIT    = (1 &amp;lt;&amp;lt; SHARED_SHIFT);&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;static final int &lt;/span&gt;MAX_COUNT      = (1 &amp;lt;&amp;lt; SHARED_SHIFT) - 1;&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;static final int &lt;/span&gt;EXCLUSIVE_MASK = (1 &amp;lt;&amp;lt; SHARED_SHIFT) - 1;&lt;br&gt;&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/** Returns the number of shared holds represented in count  */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;static int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;sharedCount&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;c&lt;/span&gt;)    { &lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;c &lt;/span&gt;&amp;gt;&amp;gt;&amp;gt; SHARED_SHIFT; }&lt;br&gt;    &lt;span style=&quot;font-style: italic&quot;&gt;/** Returns the number of exclusive holds represented in count  */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;static int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;exclusiveCount&lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;c&lt;/span&gt;) { &lt;span style=&quot;font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;c &lt;/span&gt;&amp;amp; EXCLUSIVE_MASK; }&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=16;fontColor=#000000;align=left;arcSize=10;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="1699" y="762" width="890" height="617" as="geometry" />
        </mxCell>
        <mxCell id="VkflFZi93BrO_o7EnHx4-0" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;final int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;fullTryAcquireShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * This code is in part redundant with that in&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * tryAcquireShared but is simpler overall by not&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * complicating tryAcquireShared with interactions between&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * retries and lazily reading hold counts.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;HoldCounter &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;for &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;exclusiveCount&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;getExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// else we hold the exclusive lock; blocking here&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;            // would cause deadlock.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;} &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;readerShouldBlock&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// Make sure we&#39;re not acquiring read lock reentrantly&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;firstReader &lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// assert firstReaderHoldCount &amp;gt; 0;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;} &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else &lt;/span&gt;&lt;span style=&quot;&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;cachedHoldCounter&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;|| &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;tid &lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getThreadId&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;readHolds&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;get&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;count &lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                            &lt;/span&gt;readHolds&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;remove&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;count &lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;sharedCount&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;MAX_COUNT)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;throw new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;Error&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&quot;Maximum lock count exceeded&quot;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;&quot;&gt;+ &lt;/span&gt;&lt;span style=&quot;&quot;&gt;SHARED_UNIT)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;sharedCount&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;firstReader &lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;firstReaderHoldCount &lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;} &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;firstReader &lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;firstReaderHoldCount&lt;span style=&quot;&quot;&gt;++&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;} &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else &lt;/span&gt;&lt;span style=&quot;&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;cachedHoldCounter&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;|| &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;tid &lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getThreadId&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;&quot;&gt;))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;readHolds&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;get&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;count &lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;readHolds&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;set&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;count&lt;span style=&quot;&quot;&gt;++&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;cachedHoldCounter &lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;&quot;&gt;; &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// cache for release&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=16;align=left;arcSize=4;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="40" y="3352" width="735" height="1170" as="geometry" />
        </mxCell>
        <mxCell id="VkflFZi93BrO_o7EnHx4-2" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;quot;pt mono&amp;quot; ; font-size: 12.8pt&quot;&gt;&lt;font color=&quot;#cc0000&quot;&gt;不断自旋拿读锁&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;labelBackgroundColor=none;fontSize=16;fontColor=#000000;" parent="4Kn29drxNQvWNtrvnITc-1" vertex="1">
          <mxGeometry x="412" y="3296" width="133" height="33" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-0" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="pSSy6d7iewiJqJxX9ky8-1" target="pSSy6d7iewiJqJxX9ky8-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-1" value="释放读锁" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;labelBackgroundColor=none;fontSize=30;fontColor=#000000;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="4497.5" y="40" width="137" height="31" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="pSSy6d7iewiJqJxX9ky8-3" target="pSSy6d7iewiJqJxX9ky8-7">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-3" value="释放写锁" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;labelBackgroundColor=none;fontSize=30;fontColor=#000000;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="6055.75" y="40" width="131.5" height="21" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.48;entryY=-0.005;entryDx=0;entryDy=0;entryPerimeter=0;fontSize=18;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="pSSy6d7iewiJqJxX9ky8-5" target="pSSy6d7iewiJqJxX9ky8-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-5" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;unlock&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;sync&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;releaseShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=16;align=left;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="4426" y="140" width="280" height="119" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="pSSy6d7iewiJqJxX9ky8-7" target="pSSy6d7iewiJqJxX9ky8-13">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-7" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;unlock&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;sync&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;release&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=16;align=left;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="6003" y="140" width="237" height="112" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-8" value="写锁是互斥锁，&lt;br&gt;流程和互斥锁一样" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.cloud_callout;labelBackgroundColor=none;fontSize=16;fontColor=#000000;align=left;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="6240" y="40" width="162" height="120" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;entryX=0.588;entryY=0.007;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="pSSy6d7iewiJqJxX9ky8-13" target="pSSy6d7iewiJqJxX9ky8-14">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="5510" y="838" as="targetPoint" />
            <Array as="points">
              <mxPoint x="6122" y="726" />
              <mxPoint x="5747" y="726" />
              <mxPoint x="5747" y="862" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-10" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;tryRelease()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=18;fontColor=#000000;" vertex="1" connectable="0" parent="pSSy6d7iewiJqJxX9ky8-9">
          <mxGeometry x="0.0206" y="2" relative="1" as="geometry">
            <mxPoint x="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="pSSy6d7iewiJqJxX9ky8-13" target="pSSy6d7iewiJqJxX9ky8-15">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="6122" y="726" />
              <mxPoint x="6514" y="726" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-12" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;unparkSuccessor()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=18;fontColor=#000000;" vertex="1" connectable="0" parent="pSSy6d7iewiJqJxX9ky8-11">
          <mxGeometry x="-0.0505" y="2" relative="1" as="geometry">
            <mxPoint y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-13" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;release&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;tryRelease&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;head&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;waitStatus &lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;unparkSuccessor&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="5837" y="363" width="569" height="285" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-14" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;tryRelease&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;releases&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;!&lt;/span&gt;&lt;span style=&quot;&quot;&gt;isHeldExclusively&lt;/span&gt;&lt;span style=&quot;&quot;&gt;())&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;throw new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;IllegalMonitorStateException&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() &lt;/span&gt;&lt;span style=&quot;&quot;&gt;- &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;releases&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;free &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;exclusiveCount&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;free&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;free&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;arcSize=9;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="5419" y="860" width="538" height="280" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-15" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;private void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;unparkSuccessor&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * If status is negative (i.e., possibly needing signal) try&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * to clear in anticipation of signalling.  It is OK if this&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * fails or if status is changed by waiting thread.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;waitStatus&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;lt; &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetWaitStatus&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * Thread to unpark is held in successor, which is normally&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * just the next node.  But if cancelled or apparently null,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * traverse backwards from tail to find the actual&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * non-cancelled successor.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;next&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;|| &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;waitStatus &lt;span style=&quot;&quot;&gt;&amp;gt; &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;for &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;tail&lt;span style=&quot;&quot;&gt;; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;prev&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;waitStatus &lt;span style=&quot;&quot;&gt;&amp;lt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;LockSupport&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;unpark&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;thread&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;arcSize=7;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="6067" y="860" width="666" height="610" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-16" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="pSSy6d7iewiJqJxX9ky8-20" target="pSSy6d7iewiJqJxX9ky8-21">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-17" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;tryReleaseShared()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=18;fontColor=#000000;" vertex="1" connectable="0" parent="pSSy6d7iewiJqJxX9ky8-16">
          <mxGeometry x="-0.0354" y="2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-18" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=18;fontColor=#000000;" edge="1" parent="4Kn29drxNQvWNtrvnITc-1" source="pSSy6d7iewiJqJxX9ky8-20" target="pSSy6d7iewiJqJxX9ky8-22">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-19" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;doReleaseShared()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=18;fontColor=#000000;" vertex="1" connectable="0" parent="pSSy6d7iewiJqJxX9ky8-18">
          <mxGeometry x="0.0903" y="-1" relative="1" as="geometry">
            <mxPoint y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-20" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;releaseShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;tryReleaseShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;doReleaseShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="4329" y="330" width="492" height="221" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-21" value="&lt;pre&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold ; font-style: italic&quot;&gt;tryReleaseShared&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold ; font-style: italic&quot;&gt;unused&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;font color=&quot;#994c00&quot;&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;Thread&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;currentThread&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;firstReader &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;// assert firstReaderHoldCount &amp;gt; 0;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;firstReaderHoldCount &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;firstReader &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;else&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;            &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;firstReaderHoldCount&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;--&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;} &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;else &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;HoldCounter &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;cachedHoldCounter&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;|| &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;tid &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;getThreadId&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;readHolds&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;get&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;count &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;count&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;count &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&amp;lt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;readHolds&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;remove&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;count &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&amp;lt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;throw &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;unmatchedUnlockException&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;--&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;count&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;font color=&quot;#994c00&quot;&gt;}//这一段废代码不用看，不影响释放锁，主要看下面的for循环 + CAS&lt;/font&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;for &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;;&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;) {&lt;font color=&quot;#ff0000&quot;&gt;//&lt;/font&gt;&lt;/span&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;&lt;font color=&quot;#ff0000&quot;&gt;因为读锁是共享锁，多个线程会同时持有读锁，&lt;/font&gt;&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;&lt;font color=&quot;#ff0000&quot;&gt;所以对读锁的释放不能直接减1，而是需要通过一个for循环+CAS操作不断重试。&lt;/font&gt;&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;getState&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;- &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;SHARED_UNIT&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;compareAndSetState&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;// Releasing the read lock has no effect on readers,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;            // but it may allow waiting writers to proceed if&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;            // both read and write locks are now free.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;arcSize=8;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="3920" y="818" width="667" height="812" as="geometry" />
        </mxCell>
        <mxCell id="pSSy6d7iewiJqJxX9ky8-22" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;private void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;doReleaseShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * Ensure that a release propagates, even if there are other&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * in-progress acquires/releases.  This proceeds in the usual&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * way of trying to unparkSuccessor of head if it needs&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * signal. But if it does not, status is set to PROPAGATE to&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * ensure that upon release, propagation continues.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * Additionally, we must loop in case a new node is added&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * while we are doing this. Also, unlike other uses of&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * unparkSuccessor, we need to know if CAS to reset status&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * fails, if so rechecking.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;for &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;head&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;tail&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;waitStatus&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;SIGNAL) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;!&lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetWaitStatus&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;SIGNAL&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;continue&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;            &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// loop to recheck cases&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;&quot;&gt;unparkSuccessor&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0 &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                     !&lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetWaitStatus&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;PROPAGATE))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;continue&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;                &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// loop on failed CAS&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;head&lt;span style=&quot;&quot;&gt;)                   &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// loop if head changed&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;arcSize=7;" vertex="1" parent="4Kn29drxNQvWNtrvnITc-1">
          <mxGeometry x="4644" y="818" width="713" height="702" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="QDP8r3jRsx4bfRsVqRZF" name="(读写锁)释放锁">
    <mxGraphModel dx="2514" dy="1268" grid="0" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="5000" pageHeight="3000" math="0" shadow="0">
      <root>
        <mxCell id="RbbWNVs1ZPorfGrst1G5-0" />
        <mxCell id="RbbWNVs1ZPorfGrst1G5-1" parent="RbbWNVs1ZPorfGrst1G5-0" />
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" parent="RbbWNVs1ZPorfGrst1G5-1" source="teO8W70LR5i9nKHsj_jc-0" target="teO8W70LR5i9nKHsj_jc-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-0" value="释放读锁" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;labelBackgroundColor=none;fontSize=18;fontColor=#000000;" parent="RbbWNVs1ZPorfGrst1G5-1" vertex="1">
          <mxGeometry x="626" y="279" width="106" height="27" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" parent="RbbWNVs1ZPorfGrst1G5-1" source="teO8W70LR5i9nKHsj_jc-1" target="teO8W70LR5i9nKHsj_jc-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-1" value="释放写锁" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;labelBackgroundColor=none;fontSize=18;fontColor=#000000;" parent="RbbWNVs1ZPorfGrst1G5-1" vertex="1">
          <mxGeometry x="2181.5" y="279" width="106" height="27" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.48;entryY=-0.005;entryDx=0;entryDy=0;entryPerimeter=0;fontSize=18;fontColor=#000000;" parent="RbbWNVs1ZPorfGrst1G5-1" source="teO8W70LR5i9nKHsj_jc-2" target="HiDBwtyS9m8kqqCNAFJG-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-2" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;unlock&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;sync&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;releaseShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=16;align=left;" parent="RbbWNVs1ZPorfGrst1G5-1" vertex="1">
          <mxGeometry x="539" y="360" width="280" height="119" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-0" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" parent="RbbWNVs1ZPorfGrst1G5-1" source="teO8W70LR5i9nKHsj_jc-3" target="teO8W70LR5i9nKHsj_jc-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-3" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;unlock&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;sync&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;release&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=16;align=left;" parent="RbbWNVs1ZPorfGrst1G5-1" vertex="1">
          <mxGeometry x="2116" y="360" width="237" height="112" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-4" value="写锁是互斥锁，&lt;br&gt;流程和互斥锁一样" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.cloud_callout;labelBackgroundColor=none;fontSize=16;fontColor=#000000;align=left;" parent="RbbWNVs1ZPorfGrst1G5-1" vertex="1">
          <mxGeometry x="2353" y="260" width="162" height="120" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;entryX=0.588;entryY=0.007;entryDx=0;entryDy=0;entryPerimeter=0;" parent="RbbWNVs1ZPorfGrst1G5-1" source="teO8W70LR5i9nKHsj_jc-5" target="teO8W70LR5i9nKHsj_jc-6" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1623" y="1058" as="targetPoint" />
            <Array as="points">
              <mxPoint x="2235" y="946" />
              <mxPoint x="1860" y="946" />
              <mxPoint x="1860" y="1082" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-8" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;tryRelease()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=18;fontColor=#000000;" parent="teO8W70LR5i9nKHsj_jc-7" vertex="1" connectable="0">
          <mxGeometry x="0.0206" y="2" relative="1" as="geometry">
            <mxPoint x="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" parent="RbbWNVs1ZPorfGrst1G5-1" source="teO8W70LR5i9nKHsj_jc-5" target="teO8W70LR5i9nKHsj_jc-10" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2235" y="946" />
              <mxPoint x="2627" y="946" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-12" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;unparkSuccessor()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=18;fontColor=#000000;" parent="teO8W70LR5i9nKHsj_jc-11" vertex="1" connectable="0">
          <mxGeometry x="-0.0505" y="2" relative="1" as="geometry">
            <mxPoint y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-5" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;release&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;tryRelease&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;head&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;waitStatus &lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;unparkSuccessor&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;" parent="RbbWNVs1ZPorfGrst1G5-1" vertex="1">
          <mxGeometry x="1950" y="583" width="569" height="285" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-6" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;tryRelease&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;releases&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;!&lt;/span&gt;&lt;span style=&quot;&quot;&gt;isHeldExclusively&lt;/span&gt;&lt;span style=&quot;&quot;&gt;())&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;throw new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;IllegalMonitorStateException&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;getState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() &lt;/span&gt;&lt;span style=&quot;&quot;&gt;- &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;releases&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;free &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;exclusiveCount&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;free&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;setState&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;free&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;arcSize=9;" parent="RbbWNVs1ZPorfGrst1G5-1" vertex="1">
          <mxGeometry x="1532" y="1080" width="538" height="280" as="geometry" />
        </mxCell>
        <mxCell id="teO8W70LR5i9nKHsj_jc-10" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;private void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;unparkSuccessor&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * If status is negative (i.e., possibly needing signal) try&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * to clear in anticipation of signalling.  It is OK if this&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * fails or if status is changed by waiting thread.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;waitStatus&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;lt; &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetWaitStatus&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * Thread to unpark is held in successor, which is normally&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * just the next node.  But if cancelled or apparently null,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * traverse backwards from tail to find the actual&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * non-cancelled successor.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;next&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;|| &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;waitStatus &lt;span style=&quot;&quot;&gt;&amp;gt; &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;for &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;tail&lt;span style=&quot;&quot;&gt;; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;prev&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;waitStatus &lt;span style=&quot;&quot;&gt;&amp;lt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;LockSupport&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;unpark&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;thread&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;arcSize=7;" parent="RbbWNVs1ZPorfGrst1G5-1" vertex="1">
          <mxGeometry x="2180" y="1080" width="666" height="610" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" parent="RbbWNVs1ZPorfGrst1G5-1" source="HiDBwtyS9m8kqqCNAFJG-1" target="HiDBwtyS9m8kqqCNAFJG-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-9" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;tryReleaseShared()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=18;fontColor=#000000;" parent="HiDBwtyS9m8kqqCNAFJG-4" vertex="1" connectable="0">
          <mxGeometry x="-0.0354" y="2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=18;fontColor=#000000;" parent="RbbWNVs1ZPorfGrst1G5-1" source="HiDBwtyS9m8kqqCNAFJG-1" target="HiDBwtyS9m8kqqCNAFJG-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-10" value="&lt;pre style=&quot;text-align: left ; font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;doReleaseShared()&lt;/pre&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=18;fontColor=#000000;" parent="HiDBwtyS9m8kqqCNAFJG-5" vertex="1" connectable="0">
          <mxGeometry x="0.0903" y="-1" relative="1" as="geometry">
            <mxPoint y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-1" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public final boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;releaseShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;tryReleaseShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;arg&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;doReleaseShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return true&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;return false&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;" parent="RbbWNVs1ZPorfGrst1G5-1" vertex="1">
          <mxGeometry x="442" y="550" width="492" height="221" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-2" value="&lt;pre&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;protected final boolean &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold ; font-style: italic&quot;&gt;tryReleaseShared&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold ; font-style: italic&quot;&gt;unused&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;font color=&quot;#994c00&quot;&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;Thread &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;current &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;Thread&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;currentThread&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;firstReader &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;// assert firstReaderHoldCount &amp;gt; 0;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;firstReaderHoldCount &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;firstReader &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;else&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;            &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;firstReaderHoldCount&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;--&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;} &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;else &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;HoldCounter &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;cachedHoldCounter&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;|| &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;tid &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;getThreadId&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;current&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;readHolds&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;get&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;count &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;count&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;count &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&amp;lt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;readHolds&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;remove&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;count &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&amp;lt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;throw &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;unmatchedUnlockException&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;--&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;rh&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;.&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;count&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;font color=&quot;#994c00&quot;&gt;}//这一段废代码不用看，不影响释放锁，主要看下面的for循环 + CAS&lt;/font&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;for &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;;&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;) {&lt;font color=&quot;#ff0000&quot;&gt;//&lt;/font&gt;&lt;/span&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;&lt;font color=&quot;#ff0000&quot;&gt;因为读锁是共享锁，多个线程会同时持有读锁，&lt;/font&gt;&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;&lt;font color=&quot;#ff0000&quot;&gt;所以对读锁的释放不能直接减1，而是需要通过一个for循环+CAS操作不断重试。&lt;/font&gt;&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;getState&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;c &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;- &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;SHARED_UNIT&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;compareAndSetState&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;nextc&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;// Releasing the read lock has no effect on readers,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;            // but it may allow waiting writers to proceed if&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;            // both read and write locks are now free.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-style: italic&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;nextc &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;arcSize=8;" parent="RbbWNVs1ZPorfGrst1G5-1" vertex="1">
          <mxGeometry x="33" y="1038" width="667" height="812" as="geometry" />
        </mxCell>
        <mxCell id="HiDBwtyS9m8kqqCNAFJG-3" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;private void &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;doReleaseShared&lt;/span&gt;&lt;span style=&quot;&quot;&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;/*&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * Ensure that a release propagates, even if there are other&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * in-progress acquires/releases.  This proceeds in the usual&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * way of trying to unparkSuccessor of head if it needs&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * signal. But if it does not, status is set to PROPAGATE to&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * ensure that upon release, propagation continues.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * Additionally, we must loop in case a new node is added&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * while we are doing this. Also, unlike other uses of&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * unparkSuccessor, we need to know if CAS to reset status&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     * fails, if so rechecking.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;     */&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;for &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;head&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;!= &lt;/span&gt;tail&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;waitStatus&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;SIGNAL) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;&quot;&gt;!&lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetWaitStatus&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;SIGNAL&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;continue&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;            &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// loop to recheck cases&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;&quot;&gt;unparkSuccessor&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;else if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ws &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0 &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;amp;&amp;amp;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                     !&lt;/span&gt;&lt;span style=&quot;&quot;&gt;compareAndSetWaitStatus&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;Node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;PROPAGATE))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;continue&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;                &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// loop on failed CAS&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;h &lt;/span&gt;&lt;span style=&quot;&quot;&gt;== &lt;/span&gt;head&lt;span style=&quot;&quot;&gt;)                   &lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;// loop if head changed&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;arcSize=7;" parent="RbbWNVs1ZPorfGrst1G5-1" vertex="1">
          <mxGeometry x="757" y="1038" width="713" height="702" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram name="(读写锁)中断锁 " id="ldpvKLvwOpZEDC9SE9Ql">
    <mxGraphModel dx="2514" dy="1268" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="o9VDTlM6Sd9dmmWb7DFp-0" />
        <mxCell id="o9VDTlM6Sd9dmmWb7DFp-1" parent="o9VDTlM6Sd9dmmWb7DFp-0" />
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="J9Tmd6Zy7u8FUA9VIpDE" name="模板">
    <mxGraphModel dx="2514" dy="1325" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="8500" pageHeight="20000" math="0" shadow="0">
      <root>
        <mxCell id="tAtp5M9JWyRdrx9-1-cH-0" />
        <mxCell id="tAtp5M9JWyRdrx9-1-cH-1" parent="tAtp5M9JWyRdrx9-1-cH-0" />
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-0" value="Object" style="html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=2;fontFamily=Verdana;fontSize=12;align=center;shape=mxgraph.ios7ui.horLines;" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1272.5" y="656" width="135" height="50" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-1" value="Function" style="swimlane;html=1;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#e0e0e0;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;align=center;rounded=1;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fontFamily=Verdana;fontSize=12" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1260" y="290" width="160" height="110" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-2" value="Row 1" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-1" vertex="1">
          <mxGeometry y="26" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-3" value="Row 2" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-1" vertex="1">
          <mxGeometry y="52" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-4" value="Row 3" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-1" vertex="1">
          <mxGeometry y="78" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-5" value="Function" style="swimlane;html=1;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#e0e0e0;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;align=center;rounded=1;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fontFamily=Verdana;fontSize=12" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1660" y="290" width="160" height="130" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-6" value="Row 1" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-5" vertex="1">
          <mxGeometry y="26" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-7" value="Row 2" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-5" vertex="1">
          <mxGeometry y="52" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-8" value="Row 3" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-5" vertex="1">
          <mxGeometry y="78" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-9" value="Row 4" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-5" vertex="1">
          <mxGeometry y="104" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-10" value="Function" style="swimlane;html=1;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#e0e0e0;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;align=center;rounded=1;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fontFamily=Verdana;fontSize=12" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1260" y="482" width="160" height="110" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-11" value="Row 1" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-10" vertex="1">
          <mxGeometry y="26" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-12" value="Row 2" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-10" vertex="1">
          <mxGeometry y="52" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-13" value="Row 3" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-10" vertex="1">
          <mxGeometry y="78" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-14" value="Function" style="swimlane;html=1;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#e0e0e0;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;align=center;rounded=1;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fontFamily=Verdana;fontSize=12" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1260" y="786" width="160" height="140" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-15" value="Row 1" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-14" vertex="1">
          <mxGeometry y="26" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-16" value="Row 2" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-14" vertex="1">
          <mxGeometry y="52" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-17" value="Row 3" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-14" vertex="1">
          <mxGeometry y="78" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-18" value="Row 4" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-14" vertex="1">
          <mxGeometry y="104" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-19" value="Function" style="swimlane;html=1;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#e0e0e0;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;align=center;rounded=1;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fontFamily=Verdana;fontSize=12" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1660" y="482" width="160" height="84" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-20" value="Row 1" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-19" vertex="1">
          <mxGeometry y="26" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-21" value="Row 2" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-19" vertex="1">
          <mxGeometry y="52" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-22" value="Function" style="swimlane;html=1;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#e0e0e0;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;align=center;rounded=1;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fontFamily=Verdana;fontSize=12" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1660" y="786" width="160" height="110" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-23" value="Row 1" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-22" vertex="1">
          <mxGeometry y="26" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-24" value="Row 2" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-22" vertex="1">
          <mxGeometry y="52" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-25" value="Row 3" style="text;html=1;strokeColor=none;fillColor=none;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="AeLNYvw3zZ7ImW0hco7L-22" vertex="1">
          <mxGeometry y="78" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-26" value="Object" style="html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=2;fontFamily=Verdana;fontSize=12;align=center;shape=mxgraph.ios7ui.horLines;" parent="tAtp5M9JWyRdrx9-1-cH-1" vertex="1">
          <mxGeometry x="1480" y="656" width="135" height="50" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-27" style="edgeStyle=none;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-14" target="AeLNYvw3zZ7ImW0hco7L-0" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-28" style="edgeStyle=none;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-0" target="AeLNYvw3zZ7ImW0hco7L-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-29" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;exitX=1;exitY=0.25;entryX=1;entryY=0.5;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-14" target="AeLNYvw3zZ7ImW0hco7L-13" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1450" y="821" />
              <mxPoint x="1450" y="573" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-30" value="" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-26" target="AeLNYvw3zZ7ImW0hco7L-23" edge="1">
          <mxGeometry x="-0.1342" y="32" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-31" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-10" target="AeLNYvw3zZ7ImW0hco7L-26" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1548" y="556" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-32" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-1" target="AeLNYvw3zZ7ImW0hco7L-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-33" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-22" target="AeLNYvw3zZ7ImW0hco7L-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-34" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-5" target="AeLNYvw3zZ7ImW0hco7L-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-35" style="edgeStyle=orthogonalEdgeStyle;html=1;entryX=0;entryY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;exitX=1;exitY=0.5;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-3" target="AeLNYvw3zZ7ImW0hco7L-7" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-36" style="edgeStyle=orthogonalEdgeStyle;html=1;exitX=0;exitY=0.5;entryX=1;entryY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-6" target="AeLNYvw3zZ7ImW0hco7L-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-37" style="edgeStyle=orthogonalEdgeStyle;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-4" target="AeLNYvw3zZ7ImW0hco7L-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-38" style="edgeStyle=orthogonalEdgeStyle;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-12" target="AeLNYvw3zZ7ImW0hco7L-21" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-39" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-21" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1980" y="547" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-40" style="edgeStyle=orthogonalEdgeStyle;html=1;exitX=1;exitY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-23" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1980" y="825" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-41" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;entryX=1;entryY=0.5;" parent="tAtp5M9JWyRdrx9-1-cH-1" target="AeLNYvw3zZ7ImW0hco7L-24" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1990" y="835" as="targetPoint" />
            <mxPoint x="1980" y="851" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="1980" y="851" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-42" style="edgeStyle=orthogonalEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;entryX=1;entryY=0.5;" parent="tAtp5M9JWyRdrx9-1-cH-1" target="AeLNYvw3zZ7ImW0hco7L-25" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1830.1904761904761" y="861.0952380952381" as="targetPoint" />
            <mxPoint x="1980" y="877" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="1900" y="877" />
              <mxPoint x="1900" y="877" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-43" style="edgeStyle=orthogonalEdgeStyle;html=1;exitX=1;exitY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-6" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1980" y="329" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-44" style="edgeStyle=orthogonalEdgeStyle;html=1;exitX=1;exitY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-7" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1980" y="355" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-45" style="edgeStyle=orthogonalEdgeStyle;html=1;exitX=1;exitY=0.5;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;" parent="tAtp5M9JWyRdrx9-1-cH-1" source="AeLNYvw3zZ7ImW0hco7L-8" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1980" y="381" as="targetPoint" />
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AeLNYvw3zZ7ImW0hco7L-46" style="edgeStyle=elbowEdgeStyle;html=1;labelBackgroundColor=none;startFill=0;startSize=8;endFill=1;endSize=8;fontFamily=Verdana;fontSize=12;elbow=vertical;entryX=1.011;entryY=0.152;entryPerimeter=0;" parent="tAtp5M9JWyRdrx9-1-cH-1" target="AeLNYvw3zZ7ImW0hco7L-5" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1840" y="305" as="targetPoint" />
            <mxPoint x="1980" y="310" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="1910" y="310" />
            </Array>
          </mxGeometry>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="IuhS61xIEZ5eRkF4Jo2Y" name="Condition">
    <mxGraphModel dx="-486" dy="1268" grid="0" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="3000" pageHeight="3000" math="0" shadow="0">
      <root>
        <mxCell id="rhP0OTCgmpBrCUrplGVk-0" />
        <mxCell id="rhP0OTCgmpBrCUrplGVk-1" parent="rhP0OTCgmpBrCUrplGVk-0" />
        <mxCell id="tih8tJjj4A0M9frWZ1GX-8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=18;fontColor=#000000;" parent="rhP0OTCgmpBrCUrplGVk-1" source="dvzmkYD-5V3QiwelHX7K-0" target="dvzmkYD-5V3QiwelHX7K-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dvzmkYD-5V3QiwelHX7K-0" value="&lt;p style=&quot;margin: 0px ; margin-top: 4px ; text-align: center&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;Interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br&gt;&lt;b&gt;Condition&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;&amp;nbsp; &amp;nbsp; void await() throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;&amp;nbsp; &amp;nbsp; void awaitUninterruptibly();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;&amp;nbsp; &amp;nbsp; long awaitNanos(long nanosTimeout) throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;&amp;nbsp; &amp;nbsp; boolean await(long time, TimeUnit unit) throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;&amp;nbsp; &amp;nbsp; boolean awaitUntil(Date deadline) throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;&amp;nbsp; &amp;nbsp; void signal();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;&amp;nbsp; &amp;nbsp; void signalAll();&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;rounded=0;glass=0;labelBackgroundColor=#ffffff;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;" parent="rhP0OTCgmpBrCUrplGVk-1" vertex="1">
          <mxGeometry x="3137" y="332" width="420" height="170" as="geometry" />
        </mxCell>
        <mxCell id="Qz4ncxqw-DXQbM3SfG6--0" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.415;entryY=-0.001;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="rhP0OTCgmpBrCUrplGVk-1" source="dvzmkYD-5V3QiwelHX7K-1" target="tih8tJjj4A0M9frWZ1GX-10">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dvzmkYD-5V3QiwelHX7K-1" value="&lt;p style=&quot;margin: 0px ; margin-top: 4px ; text-align: center&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;Class&amp;gt;&amp;gt;&lt;/i&gt;&lt;br&gt;&lt;b&gt;ConditionObject&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;+&amp;nbsp; firstWaiter:Node //双向链表头指针&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;+&amp;nbsp;&amp;nbsp;lastWaiter: Node//双向链表尾指针&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;/p&gt;&lt;span style=&quot;font-size: x-small&quot;&gt;&amp;nbsp;void await() throws InterruptedException;&lt;/span&gt;&lt;br&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;void awaitUninterruptibly();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;&lt;span style=&quot;font-size: x-small&quot;&gt;long awaitNanos(long nanosTimeout) throws InterruptedException;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;boolean await(long time, TimeUnit unit) throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;boolean awaitUntil(Date deadline) throws InterruptedException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;void signal();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px ; margin-left: 4px&quot;&gt;&lt;font size=&quot;1&quot;&gt;void signalAll();&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;rounded=0;glass=0;labelBackgroundColor=#ffffff;fontColor=#000000;strokeColor=#000000;fillColor=#ffffff;" parent="rhP0OTCgmpBrCUrplGVk-1" vertex="1">
          <mxGeometry x="3137" y="571" width="430" height="223" as="geometry" />
        </mxCell>
        <mxCell id="dvzmkYD-5V3QiwelHX7K-2" value="Condition功能和wait/notify类似，用来线程间通信，wait（）/notify（）必须和synchronized一起使用，Condition也是如此，必须和Lock一起使用。" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.cloud_callout;labelBackgroundColor=#ffffff;fontSize=18;fontColor=#000000;align=left;" parent="rhP0OTCgmpBrCUrplGVk-1" vertex="1">
          <mxGeometry x="3562" y="205" width="548" height="208" as="geometry" />
        </mxCell>
        <mxCell id="tih8tJjj4A0M9frWZ1GX-0" value="&lt;h1&gt;Condition实现原理&lt;/h1&gt;&lt;p&gt;因为Condition必须和Lock一起使用，所以Condition的实现也是Lock的一部分。下面先分别看一下互斥锁和读写锁中Condition的构造，互斥锁和读写锁中的写锁都是返回一个ConditionObject对象，而读写锁中的读锁 不支持Condition，每一个Condition对象上面，都阻塞了多个线程。因此，在ConditionObject内部也有一个双向链表组成的队列&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;labelBackgroundColor=#ffffff;fontSize=18;fontColor=#000000;align=left;" parent="rhP0OTCgmpBrCUrplGVk-1" vertex="1">
          <mxGeometry x="3083" y="28" width="544" height="230" as="geometry" />
        </mxCell>
        <mxCell id="tih8tJjj4A0M9frWZ1GX-9" value="ConditionObject是AQS的一个内部类" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.cloud_callout;labelBackgroundColor=#ffffff;fontSize=18;fontColor=#000000;align=left;" parent="rhP0OTCgmpBrCUrplGVk-1" vertex="1">
          <mxGeometry x="3576" y="527" width="340" height="86" as="geometry" />
        </mxCell>
        <mxCell id="tih8tJjj4A0M9frWZ1GX-10" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;font color=&quot;#ea6b66&quot; style=&quot;font-size: 16px ; white-space: normal&quot;&gt;//释放锁，阻塞自己，进入&lt;/font&gt;&lt;font color=&quot;#ea6b66&quot; style=&quot;font-size: 16px ; white-space: normal&quot;&gt;Condition等待队列,相当于synchronized的等待池&lt;/font&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;font-size: 16px&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;public final void &lt;/span&gt;&lt;span style=&quot;font-weight: bold ; font-style: italic&quot;&gt;await&lt;/span&gt;() &lt;span style=&quot;font-weight: bold&quot;&gt;throws &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;InterruptedException &lt;/span&gt;{&lt;font color=&quot;#ea6b66&quot;&gt;//await()会响应中断&lt;/font&gt;&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;(&lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;.interrupted())&lt;br&gt;        &lt;span style=&quot;font-weight: bold&quot;&gt;throw new &lt;/span&gt;InterruptedException();&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node &lt;/span&gt;= addConditionWaiter();&lt;font color=&quot;#ea6b66&quot;&gt;//添加到Condition等待队列&lt;/font&gt;&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;savedState &lt;/span&gt;= fullyRelease(&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;);&lt;font color=&quot;#ea6b66&quot;&gt;//阻塞之前必须先释放锁，否则会死锁&lt;/font&gt;&lt;br&gt;    &lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interruptMode &lt;/span&gt;= 0;&lt;/pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;    &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;while &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;(!isOnSyncQueue(&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;)) {&lt;/span&gt;&lt;/font&gt;&lt;font color=&quot;#ea6b66&quot;&gt;&lt;font style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 16px&quot;&gt;//&lt;/font&gt;isOnSyncQueue()是AQS里的函数,&lt;br&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot; style=&quot;font-size: 16px&quot; color=&quot;#ea6b66&quot;&gt;&lt;span&gt; &lt;font style=&quot;font-size: 16px&quot;&gt;   用于判断该Node是否在AQS的同步队列里面;初始的时候，Node只在Condition的队列里，&lt;/font&gt;&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;font face=&quot;pt mono&quot; style=&quot;font-size: 16px&quot; color=&quot;#ea6b66&quot;&gt;&lt;span&gt;&lt;font style=&quot;font-size: 16px&quot;&gt;    而不在AQS的队列里。但执行notity操作的时候，会放进AQS的同步队列&lt;/font&gt;。&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;        &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;LockSupport&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;.park(&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;this&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;);&lt;/span&gt;&lt;/font&gt;&lt;font color=&quot;#ea6b66&quot; style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;//阻塞自己&lt;/font&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;&lt;br&gt;        &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;((&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;interruptMode &lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;= checkInterruptWhileWaiting(&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;)) != 0)&lt;br&gt;            &lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt ; font-weight: bold&quot;&gt;break&lt;/span&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 12.8pt&quot;&gt;;&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;font color=&quot;#ea6b66&quot;&gt;&lt;span&gt;	&lt;/span&gt;不是被中断唤醒，跳出循环，进行后面流程&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;font color=&quot;#ea6b66&quot;&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;&lt;span&gt;	&lt;/span&gt;检测在park期间是否收到过中断信号；当线程被唤醒时，有两种可能：&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;font color=&quot;#ea6b66&quot;&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;&lt;span&gt;	&lt;/span&gt;(1)其他线程调用了unpark()；&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre&gt;&lt;font color=&quot;#ea6b66&quot;&gt;&lt;font face=&quot;pt mono&quot;&gt;&lt;span style=&quot;font-size: 17.0667px&quot;&gt;&lt;span&gt;	&lt;/span&gt;(2)收到中断信号；&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;  &lt;font color=&quot;#ea6b66&quot;&gt;  //重新拿锁，&lt;/font&gt;&lt;font color=&quot;#ea6b66&quot;&gt;acquireQueued()返回是否被中断&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;acquireQueued&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;savedState&lt;/span&gt;&lt;span&gt;) &lt;/span&gt;&lt;span&gt;&amp;amp;&amp;amp; &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interruptMode &lt;/span&gt;&lt;span&gt;!= &lt;/span&gt;&lt;span&gt;THROW_IE)&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interruptMode &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span&gt;REINTERRUPT&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;nextWaiter &lt;span&gt;!= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;null&lt;/span&gt;&lt;span&gt;) &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;// clean up if cancelled&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;        &lt;/span&gt;&lt;span&gt;unlinkCancelledWaiters&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interruptMode &lt;/span&gt;&lt;span&gt;!= &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;)&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;reportInterruptAfterWait&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interruptMode&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;arcSize=5;verticalAlign=top;shadow=1;sketch=0;glass=1;" parent="rhP0OTCgmpBrCUrplGVk-1" vertex="1">
          <mxGeometry x="3038" y="885" width="757" height="788" as="geometry" />
        </mxCell>
        <mxCell id="cty0Z-pJkADAmItuoEGn-0" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-size: 12.8pt ; white-space: normal ; font-weight: bold&quot;&gt;public final void &lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; white-space: normal ; font-weight: bold ; font-style: italic&quot;&gt;awaitUninterruptibly&lt;/span&gt;&lt;span style=&quot;font-size: 12.8pt ; white-space: normal&quot;&gt;() {&lt;font color=&quot;#ea6b66&quot;&gt;//不会响应中断&lt;/font&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Node &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span&gt;addConditionWaiter&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;savedState &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span&gt;fullyRelease&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interrupted &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;false&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;while &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;!&lt;/span&gt;&lt;span&gt;isOnSyncQueue&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;)) {&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;LockSupport&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;park&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;this&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Thread&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;interrupted&lt;/span&gt;&lt;span&gt;())&lt;br&gt;&lt;/span&gt;&lt;span&gt;            &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interrupted &lt;/span&gt;&lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;true&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;}&lt;br&gt;&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;if &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;acquireQueued&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;node&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;savedState&lt;/span&gt;&lt;span&gt;) &lt;/span&gt;&lt;span&gt;|| &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;interrupted&lt;/span&gt;&lt;span&gt;)&lt;br&gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;selfInterrupt&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=7;shadow=1;glass=1;labelBackgroundColor=#ffffff;align=left;" vertex="1" parent="rhP0OTCgmpBrCUrplGVk-1">
          <mxGeometry x="3903" y="891" width="587" height="326" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="RcCwE2SFOWVnL2of2GJ7" name="阻塞队列">
    <mxGraphModel dx="2514" dy="1325" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="3000" pageHeight="3000" math="0" shadow="0">
      <root>
        <mxCell id="aZrIO7PyOFQsN65T9nqu-0" />
        <mxCell id="aZrIO7PyOFQsN65T9nqu-1" parent="aZrIO7PyOFQsN65T9nqu-0" />
        <mxCell id="aZrIO7PyOFQsN65T9nqu-2" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;ArrayBlockingQueue&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;capacity&lt;/span&gt;&lt;span style=&quot;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;boolean &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;fair&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;capacity &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;lt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;throw new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;IllegalArgumentException&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;items &lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;Object&lt;/span&gt;&lt;span style=&quot;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;capacity&lt;/span&gt;&lt;span style=&quot;&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;lock &lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;ReentrantLock&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;fair&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;notEmpty &lt;span style=&quot;&quot;&gt;= &lt;/span&gt;lock&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;newCondition&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;notFull &lt;span style=&quot;&quot;&gt;=  &lt;/span&gt;lock&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;&quot;&gt;newCondition&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;arcSize=10;" parent="aZrIO7PyOFQsN65T9nqu-1" vertex="1">
          <mxGeometry x="350" y="440" width="580" height="230" as="geometry" />
        </mxCell>
        <mxCell id="aZrIO7PyOFQsN65T9nqu-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=18;fontColor=#000000;" parent="aZrIO7PyOFQsN65T9nqu-1" source="aZrIO7PyOFQsN65T9nqu-3" target="aZrIO7PyOFQsN65T9nqu-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="aZrIO7PyOFQsN65T9nqu-3" value="ArrayBlockingQueue" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;labelBackgroundColor=#ffffff;fontSize=18;fontColor=#000000;" parent="aZrIO7PyOFQsN65T9nqu-1" vertex="1">
          <mxGeometry x="550" y="300" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="aZrIO7PyOFQsN65T9nqu-5" value="核心：&lt;br&gt;（1）基于数组实现&lt;br&gt;（2）1把互斥锁 + 2个Condition&lt;br&gt;（3）可以指定锁的类型（公平 | 非公平）" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.roundRectCallout;dx=30;dy=15;size=5;boundedLbl=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;" parent="aZrIO7PyOFQsN65T9nqu-1" vertex="1">
          <mxGeometry x="810" y="180" width="370" height="180" as="geometry" />
        </mxCell>
        <mxCell id="aZrIO7PyOFQsN65T9nqu-7" value="LinkedBlockingQueue" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;labelBackgroundColor=#ffffff;fontSize=18;fontColor=#000000;" parent="aZrIO7PyOFQsN65T9nqu-1" vertex="1">
          <mxGeometry x="1590" y="290" width="40" height="20" as="geometry" />
        </mxCell>
        <mxCell id="aZrIO7PyOFQsN65T9nqu-8" value="&lt;pre style=&quot;font-family: &amp;quot;pt mono&amp;quot;; font-size: 12.8pt;&quot;&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;public &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;LinkedBlockingQueue&lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;int &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;capacity&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;capacity &lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;lt;= &lt;/span&gt;&lt;span style=&quot;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;throw new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;IllegalArgumentException&lt;/span&gt;&lt;span style=&quot;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;&quot;&gt;.&lt;/span&gt;capacity &lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold; font-style: italic;&quot;&gt;capacity&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;    &lt;/span&gt;last &lt;span style=&quot;&quot;&gt;= &lt;/span&gt;head &lt;span style=&quot;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;new &lt;/span&gt;&lt;span style=&quot;&quot;&gt;Node&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;E&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;gt;(&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;&quot;&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;" parent="aZrIO7PyOFQsN65T9nqu-1" vertex="1">
          <mxGeometry x="1510" y="400" width="640" height="150" as="geometry" />
        </mxCell>
        <mxCell id="aZrIO7PyOFQsN65T9nqu-9" value="核心：&lt;br&gt;（1）基于单向链表实现&lt;br&gt;（2）2把互斥锁 + 2个Condition，读线程与写线程是分开的，相互不影响&lt;br&gt;（3）使用非公平锁，不能指定锁类型" style="whiteSpace=wrap;html=1;shape=mxgraph.basic.roundRectCallout;dx=30;dy=15;size=5;boundedLbl=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;" parent="aZrIO7PyOFQsN65T9nqu-1" vertex="1">
          <mxGeometry x="1700" y="170" width="620" height="150" as="geometry" />
        </mxCell>
        <mxCell id="ZZE2RP4JMpxsp6Ju23jP-0" value="&lt;pre style=&quot;font-family: &amp;#34;pt mono&amp;#34; ; font-size: 12.8pt&quot;&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;private final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ReentrantLock &lt;/span&gt;takeLock &lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;new &lt;/span&gt;&lt;span&gt;ReentrantLock&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;private final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Condition &lt;/span&gt;notEmpty &lt;span&gt;= &lt;/span&gt;takeLock&lt;span&gt;.&lt;/span&gt;&lt;span&gt;newCondition&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;private final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;ReentrantLock &lt;/span&gt;putLock &lt;span&gt;= &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;new &lt;/span&gt;&lt;span&gt;ReentrantLock&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;private final &lt;/span&gt;&lt;span style=&quot;font-weight: bold&quot;&gt;Condition &lt;/span&gt;notFull &lt;span&gt;= &lt;/span&gt;putLock&lt;span&gt;.&lt;/span&gt;&lt;span&gt;newCondition&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;span&gt;;&lt;/span&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=#ffffff;fontSize=18;align=left;arcSize=7;" parent="aZrIO7PyOFQsN65T9nqu-1" vertex="1">
          <mxGeometry x="1530" y="620" width="620" height="190" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
